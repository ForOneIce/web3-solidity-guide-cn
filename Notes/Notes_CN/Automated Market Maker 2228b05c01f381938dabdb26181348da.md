# è‡ªåŠ¨åŒ–åšå¸‚å•†(AMM)

æ¬¢è¿å›åˆ° **Solidity 30å¤©**â€”â€”æ¯ä¸€å¤©,æˆ‘ä»¬å°†ä¸€ä¸ªå¤æ‚çš„æ¦‚å¿µè½¬åŒ–ä¸ºä½ èƒ½çœŸæ­£ç†è§£çš„ä»£ç ã€‚

ä»Šå¤©,æˆ‘ä»¬å°†æ­å¼€DeFiä¸­æœ€ä¼ å¥‡æœºåˆ¶ä¹‹ä¸€çš„ç¥ç§˜é¢çº±:

**è‡ªåŠ¨åŒ–åšå¸‚å•†** â€”â€” æˆ–ç§°AMMã€‚

è¿™æ˜¯ **DeFiä¸­æœ€å¼ºå¤§çš„å‘æ˜ä¹‹ä¸€** â€”â€” è¿™ç§ä¸œè¥¿å¸®åŠ©å°†æ™ºèƒ½åˆçº¦å˜æˆäº†æˆç†Ÿçš„é‡‘èåº”ç”¨ã€‚

## ğŸ›ï¸ ä»å‰:äººä»¬å¦‚ä½•äº¤æ˜“åŠ å¯†è´§å¸

è®©æˆ‘ä»¬å›åˆ°äº¤æ˜“æœ€åˆçš„è¿ä½œæ–¹å¼â€”â€”å³ä½¿åœ¨åŠ å¯†è´§å¸æ—©æœŸ:

å°±åƒè‚¡ç¥¨å¸‚åœºä¸€æ ·ã€‚

- ä½ æœ‰ **ä¹°å®¶**,ä»–ä»¬è¯´:
  *"æˆ‘æƒ³ä¹°1 DAI,æˆ‘æ„¿æ„æ”¯ä»˜0.95 ETHã€‚"*

- ä½ æœ‰ **å–å®¶**,ä»–ä»¬è¯´:
  *"æˆ‘æœ‰1 DAIè¦å–,ä½†æˆ‘æƒ³è¦1 ETHã€‚"*

- ä¸­é—´æœ‰ä¸€ä¸ªå«åš **è®¢å•ç°¿** çš„ç³»ç»Ÿã€‚
  æƒ³è±¡å®ƒåƒä¸€ä¸ªå·¨å¤§çš„åˆ—è¡¨,åŒ¹é…ä¹°å®¶å’Œå–å®¶ã€‚

å½“ä¹°å®¶å’Œå–å®¶éƒ½åŒæ„ä¸€ä¸ªä»·æ ¼æ—¶?ç °â€”â€”äº¤æ˜“å‘ç”Ÿäº†ã€‚

è¿™ä¸ªç³»ç»Ÿåœ¨åƒBinanceæˆ–Coinbaseè¿™æ ·çš„ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ä¸Šè¿è¡Œè‰¯å¥½ã€‚

ä½†æœ‰ä¸ªé—®é¢˜...

## ğŸ¤• ä¸ºä»€ä¹ˆè¿™åœ¨é“¾ä¸Šä¸èµ·ä½œç”¨

åœ¨åŒºå—é“¾ä¸Š,ä¸€åˆ‡éƒ½è¦èŠ±è´¹ **gas**ã€‚

å³ä½¿æ˜¯åƒ"æˆ‘æƒ³ä¹°DAI"è¿™æ ·ç®€å•çš„äº‹æƒ…ä¹Ÿæ„å‘³ç€:

- å‘é€äº¤æ˜“
- æ”¯ä»˜è´¹ç”¨
- ç­‰å¾…ç¡®è®¤

æƒ³è±¡ä¸€ä¸‹,å¿…é¡»ä¸ºæ¯ä¸€æ¬¡å¯¹ä¹°å…¥æˆ–å–å‡ºä»·æ ¼çš„å¾®å°æ”¹å˜éƒ½è¿™æ ·åšã€‚é‚£æ˜¯å™©æ¢¦ã€‚

å¦‚æœé‚£æ—¶æ²¡æœ‰äººæƒ³å’Œä½ äº¤æ˜“æ€ä¹ˆåŠ?

ä½ è¢«å¡ä½äº†ã€‚ä½ çš„è®¢å•å°±åœ¨é‚£é‡Œ,æµªè´¹gaså’Œæ—¶é—´ã€‚

æ‰€ä»¥è¿™æ˜¯æ ¸å¿ƒé—®é¢˜:

- è®¢å•ç°¿æ˜¯ **ä¸­å¿ƒåŒ–çš„**
- å®ƒä»¬éœ€è¦äººä»¬ä¸€ç›´ä¿æŒæ´»è·ƒ
- åœ¨é“¾ä¸Šä½¿ç”¨ç¼“æ…¢ä¸”æ˜‚è´µ

DeFiéœ€è¦ **æ›´å¥½çš„** ä¸œè¥¿ã€‚

## ğŸ’¡ çªç ´:å¦‚æœæˆ‘ä»¬ä¸éœ€è¦ä¹°å®¶å’Œå–å®¶å‘¢?

è¿™æ˜¯æ”¹å˜ä¸€åˆ‡çš„ç»å¦™æƒ³æ³•:

> å¦‚æœäººä»¬ä¸éœ€è¦ç­‰å¾…äº¤æ˜“ä¼™ä¼´å‘¢?
> 
> å¦‚æœæ™ºèƒ½åˆçº¦å°±åƒä»£å¸çš„è‡ªåŠ¨è´©å–æœºå‘¢?

æ‰€ä»¥,ä¸ä¾èµ–å…¶ä»–äººæ¥äº¤æ˜“...

ä½ ä¼šæœ‰ä¸¤ä¸ªä»£å¸çš„æ± å­â€”â€”æ¯”å¦‚DAIå’ŒETHâ€”â€”é”å®šåœ¨ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨çš„åˆçº¦ä¸­ã€‚

æƒ³ç”¨DAI **è´­ä¹°ETH**?

åˆçº¦è¿›è¡Œæ•°å­¦è®¡ç®—,ç»™ä½ ETH,å¹¶ä¿ç•™ä½ çš„DAIã€‚

æƒ³ç”¨ETH **å…‘æ¢DAI**?

åŒæ ·çš„äº‹æƒ…â€”â€”åˆçº¦ç»™ä½ DAIå¹¶å­˜å‚¨ä½ çš„ETHã€‚

ä¸éœ€è¦ä¹°å®¶ã€‚ä¸éœ€è¦å–å®¶ã€‚åªéœ€è¦æ•°å­¦ã€‚

## ğŸ“ å¥½çš„...ä½†å®ƒå®é™…ä¸Šæ˜¯å¦‚ä½•å·¥ä½œçš„?

AMMä½¿ç”¨ä¸€ä¸ªç®€å•çš„å…¬å¼:

> x Ã— y = k

è®©æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹ã€‚

- `x` = æ± ä¸­ä»£å¸Açš„æ•°é‡
- `y` = æ± ä¸­ä»£å¸Bçš„æ•°é‡
- `k` = æŸä¸ªå¸¸æ•°(å®ƒæ°¸è¿œä¸ä¼šæ”¹å˜)

æ‰€ä»¥ **ä¸¤ä¸ªä»£å¸å‚¨å¤‡çš„ä¹˜ç§¯å¿…é¡»å§‹ç»ˆä¿æŒä¸å˜**ã€‚

è¿™æ˜¯é­”æ³•æ‰€åœ¨:

å¦‚æœæœ‰äººæƒ³æ·»åŠ æ›´å¤šçš„ä»£å¸A(å¦‚ETH),

ä¿æŒ `k` ä¸å˜çš„å”¯ä¸€æ–¹æ³•æ˜¯åˆçº¦ç»™ä»–ä»¬ *æ›´å°‘* çš„ä»£å¸B(å¦‚DAI)ã€‚

è¿™å°±æ˜¯ä»·æ ¼å¦‚ä½•è‡ªåŠ¨è°ƒæ•´â€”â€”**è‡ªåŠ¨åœ°**ã€‚

éšç€äººä»¬äº¤æ˜“æ›´å¤š,æ¯”ç‡ä¼šæ”¹å˜â€”â€”ä»·æ ¼ä¼šè‡ªè¡Œæ›´æ–°ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè¢«ç§°ä¸º **è‡ªåŠ¨åŒ–åšå¸‚å•†**ã€‚

åˆçº¦ä½¿ç”¨æ•°å­¦ *åˆ¶é€ å¸‚åœº*,è€Œä¸æ˜¯äººå·¥è®¢å•ã€‚

## ğŸ” ä½ å¯ä»¥ç”¨AMMåšä»€ä¹ˆ?

ä½ å¯ä»¥åšä¸‰ä»¶å¤§äº‹:

1. **äº¤æ¢** ä»£å¸
   - å³æ—¶å°†ä»£å¸Aæ¢æˆä»£å¸B(æˆ–åè¿‡æ¥)
   - ä¸éœ€è¦ç­‰å¾…åŒ¹é…
   - åªéœ€å‘é€ä»£å¸,è·å¾—å¦ä¸€ä¸ª

2. **æ·»åŠ æµåŠ¨æ€§**
   - å­˜å…¥ç­‰å€¼çš„ä»£å¸Aå’ŒB
   - ä½ è·å¾— **LPä»£å¸**(åƒæ”¶æ®)
   - å½“ä½ çš„ä»£å¸åœ¨æ± ä¸­æ—¶,ä½ èµšå–äº¤æ˜“è´¹ç”¨çš„ä¸€éƒ¨åˆ†

3. **ç§»é™¤æµåŠ¨æ€§**
   - è¿”è¿˜ä½ çš„LPä»£å¸
   - è·å¾—ä½ ä¸¤ä¸ªä»£å¸çš„ä»½é¢

ç°åœ¨ä½ æ˜ç™½äº†è¿™ä¸ªæƒ³æ³•...

åœ¨ä¸‹ä¸€èŠ‚ä¸­,æˆ‘ä»¬å°†çœ‹ä¸€ä¸ªå®é™…çš„Solidityåˆçº¦â€”â€”å¹¶é€æ­¥äº†è§£å¦‚ä½• **ä»å¤´ç¼–å†™ä½ è‡ªå·±çš„AMM**ã€‚

## ğŸ› ï¸ ä½ ä»Šå¤©è¦æ„å»ºä»€ä¹ˆ

å¥½çš„,æ‰€ä»¥ä»Šå¤©çš„é¡¹ç›®ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç©å…·åˆçº¦ã€‚

ä½ æ­£åœ¨æ„å»º **é©±åŠ¨å»ä¸­å¿ƒåŒ–äº¤æ˜“ä¸­æ•°åäº¿ç¾å…ƒçš„æ ¸å¿ƒå¼•æ“**ã€‚

ä½†è¿™é‡Œæœ‰ä¸ªè½¬æŠ˜:

- **æ²¡æœ‰åº“**
- **æ²¡æœ‰æ·å¾„**
- **æ²¡æœ‰å¹•åé­”æ³•**

ä½ å°†è¦æ‰‹å·¥ç¼–å†™è‡ªåŠ¨åŒ–åšå¸‚å•†çš„æ ¸å¿ƒâ€”â€”è¿™æ˜¯ *çœŸæ­£* ç†è§£å®ƒå¦‚ä½•å·¥ä½œçš„æœ€ä½³æ–¹å¼ã€‚

## åˆçº¦è¯¦è§£

### å¯¼å…¥ERC20æ ‡å‡†
```solidity
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
```

### åˆçº¦å£°æ˜
```solidity
contract AutomatedMarketMaker is ERC20 {
    IERC20 public tokenA;
    IERC20 public tokenB;
    
    uint256 public reserveA;
    uint256 public reserveB;
    
    address public owner;
}
```

### äº‹ä»¶
```solidity
event LiquidityAdded(address indexed provider, uint256 amountA, uint256 amountB, uint256 liquidity);
event LiquidityRemoved(address indexed provider, uint256 amountA, uint256 amountB, uint256 liquidity);
event TokensSwapped(address indexed trader, address tokenIn, uint256 amountIn, address tokenOut, uint256 amountOut);
```

### æ„é€ å‡½æ•°
```solidity
constructor(address _tokenA, address _tokenB, string memory _name, string memory _symbol) 
    ERC20(_name, _symbol) 
{
    tokenA = IERC20(_tokenA);
    tokenB = IERC20(_tokenB);
    owner = msg.sender;
}
```

### æ·»åŠ æµåŠ¨æ€§
```solidity
function addLiquidity(uint256 amountA, uint256 amountB) external {
    require(amountA > 0 && amountB > 0, "Amounts must be > 0");
    
    tokenA.transferFrom(msg.sender, address(this), amountA);
    tokenB.transferFrom(msg.sender, address(this), amountB);
    
    uint256 liquidity;
    if (totalSupply() == 0) {
        liquidity = sqrt(amountA * amountB);
    } else {
        liquidity = min(
            amountA * totalSupply() / reserveA,
            amountB * totalSupply() / reserveB
        );
    }
    
    _mint(msg.sender, liquidity);
    
    reserveA += amountA;
    reserveB += amountB;
    
    emit LiquidityAdded(msg.sender, amountA, amountB, liquidity);
}
```

### ç§»é™¤æµåŠ¨æ€§
```solidity
function removeLiquidity(uint256 liquidityToRemove) external returns (uint256 amountAOut, uint256 amountBOut) {
    require(liquidityToRemove > 0, "Liquidity to remove must be > 0");
    require(balanceOf(msg.sender) >= liquidityToRemove, "Insufficient liquidity tokens");
    
    uint256 totalLiquidity = totalSupply();
    require(totalLiquidity > 0, "No liquidity in the pool");
    
    amountAOut = liquidityToRemove * reserveA / totalLiquidity;
    amountBOut = liquidityToRemove * reserveB / totalLiquidity;
    
    require(amountAOut > 0 && amountBOut > 0, "Insufficient reserves for requested liquidity");
    
    reserveA -= amountAOut;
    reserveB -= amountBOut;
    
    _burn(msg.sender, liquidityToRemove);
    
    tokenA.transfer(msg.sender, amountAOut);
    tokenB.transfer(msg.sender, amountBOut);
    
    emit LiquidityRemoved(msg.sender, amountAOut, amountBOut, liquidityToRemove);
    return (amountAOut, amountBOut);
}
```

### äº¤æ¢Aæ¢B
```solidity
function swapAforB(uint256 amountAIn, uint256 minBOut) external {
    require(amountAIn > 0, "Amount must be > 0");
    require(reserveA > 0 && reserveB > 0, "Insufficient reserves");
    
    uint256 amountAInWithFee = amountAIn * 997 / 1000;
    uint256 amountBOut = reserveB * amountAInWithFee / (reserveA + amountAInWithFee);
    
    require(amountBOut >= minBOut, "Slippage too high");
    
    tokenA.transferFrom(msg.sender, address(this), amountAIn);
    tokenB.transfer(msg.sender, amountBOut);
    
    reserveA += amountAInWithFee;
    reserveB -= amountBOut;
    
    emit TokensSwapped(msg.sender, address(tokenA), amountAIn, address(tokenB), amountBOut);
}
```

### äº¤æ¢Bæ¢A
```solidity
function swapBforA(uint256 amountBIn, uint256 minAOut) external {
    require(amountBIn > 0, "Amount must be > 0");
    require(reserveA > 0 && reserveB > 0, "Insufficient reserves");
    
    uint256 amountBInWithFee = amountBIn * 997 / 1000;
    uint256 amountAOut = reserveA * amountBInWithFee / (reserveB + amountBInWithFee);
    
    require(amountAOut >= minAOut, "Slippage too high");
    
    tokenB.transferFrom(msg.sender, address(this), amountBIn);
    tokenA.transfer(msg.sender, amountAOut);
    
    reserveB += amountBInWithFee;
    reserveA -= amountAOut;
    
    emit TokensSwapped(msg.sender, address(tokenB), amountBIn, address(tokenA), amountAOut);
}
```

### å·¥å…·å‡½æ•°
```solidity
function getReserves() external view returns (uint256, uint256) {
    return (reserveA, reserveB);
}

function min(uint256 a, uint256 b) internal pure returns (uint256) {
    return a < b ? a : b;
}

function sqrt(uint256 y) internal pure returns (uint256 z) {
    if (y > 3) {
        z = y;
        uint256 x = y / 2 + 1;
        while (x < z) {
            z = x;
            x = (y / x + x) / 2;
        }
    } else if (y != 0) {
        z = 1;
    }
}
```

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### å¸¸æ•°ä¹˜ç§¯å…¬å¼
```
x * y = k
```
è¿™ç¡®ä¿:
- ä½ äº¤æ¢å¾—è¶Šå¤š,ä»·æ ¼å˜åŠ¨è¶Šå¤§(æ»‘ç‚¹)
- æ± å­æ°¸è¿œä¸ä¼šå®Œå…¨è€—å°½
- äº¤æ¢æ€»æ˜¯ä½¿ `x * y` å¤§è‡´ç›¸åŒ

### LPä»£å¸
- ä»£è¡¨ä½ åœ¨æ± ä¸­çš„æ‰€æœ‰æƒä»½é¢
- å¦‚æœä½ æ‹¥æœ‰10%çš„LP,ä½ æ‹¥æœ‰10%çš„ä»£å¸
- å¯ä»¥éšæ—¶èµå›ä½ çš„ä»½é¢

### äº¤æ˜“è´¹ç”¨
0.3%çš„è´¹ç”¨åº”ç”¨äºæ¯ç¬”äº¤æ˜“:
```solidity
uint256 amountAInWithFee = amountAIn * 997 / 1000;
```

### æ»‘ç‚¹ä¿æŠ¤
```solidity
require(amountBOut >= minBOut, "Slippage too high");
```
ä¿æŠ¤ç”¨æˆ·å…å—æ„å¤–ä»·æ ¼å˜åŠ¨çš„å½±å“ã€‚

## ğŸ‰ æ€»ç»“

ä½ åˆšåˆšæ„å»ºäº†ä¸€ä¸ªDEXå¼•æ“!

ç°åœ¨ä½ äº†è§£äº†:
- AMMå¦‚ä½•ä½¿ç”¨æ•°å­¦è€Œä¸æ˜¯è®¢å•ç°¿
- æµåŠ¨æ€§æ± å¦‚ä½•å·¥ä½œ
- LPä»£å¸ä¸ºä½•é‡è¦
- ä»·æ ¼å‘ç°ã€æ»‘ç‚¹å’Œè´¹ç”¨å¦‚ä½•èå…¥æ•°å­¦ä¸­

è¿™ä¸ä»…ä»…æ˜¯ä»£ç â€”â€”è¿™æ˜¯çœŸæ­£ç†è§£DeFiè¿ä½œæ–¹å¼çš„æŠ€èƒ½ã€‚

