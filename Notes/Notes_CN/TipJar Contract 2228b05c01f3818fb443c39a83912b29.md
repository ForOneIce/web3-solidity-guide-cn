# 小费罐合约

本教程构建了一个TipJar合约,可以直接接收ETH小费或以其他货币(USD、EUR、JPY)接收,通过转换为ETH。解释了以wei为单位处理ETH、货币转换计算和安全提取。

## 关键概念

### 状态变量
```solidity
address public owner;
mapping(string => uint256) public conversionRates;
string[] public supportedCurrencies;
uint256 public totalTipsReceived;
mapping(address => uint256) public tipperContributions;
mapping(string => uint256) public tipsPerCurrency;
```

### 修饰符
```solidity
modifier onlyOwner() {
    require(msg.sender == owner, "Not the owner");
    _;
}
```

### 添加货币
```solidity
function addCurrency(string memory _currencyCode, uint256 _rateToEth) public onlyOwner {
    bool exists = false;
    for (uint i = 0; i < supportedCurrencies.length; i++) {
        if (keccak256(bytes(supportedCurrencies[i])) == keccak256(bytes(_currencyCode))) {
            exists = true;
            break;
        }
    }
    
    if (!exists) {
        supportedCurrencies.push(_currencyCode);
    }
    
    conversionRates[_currencyCode] = _rateToEth;
}
```

### 构造函数
```solidity
constructor() {
    owner = msg.sender;
    // 1 ETH = 10^18 wei
    addCurrency("ETH", 1 ether);
}
```

### 货币转换
```solidity
function convertToEth(string memory _currencyCode, uint256 _amount) public view returns (uint256) {
    uint256 rate = conversionRates[_currencyCode];
    require(rate > 0, "Currency not supported");
    return (_amount * 1 ether) / rate;
}
```

### 直接ETH小费
```solidity
function tipInEth() public payable {
    require(msg.value > 0, "Must send ETH");
    
    totalTipsReceived += msg.value;
    tipperContributions[msg.sender] += msg.value;
    tipsPerCurrency["ETH"] += msg.value;
}
```

### 货币小费
```solidity
function tipInCurrency(string memory _currencyCode, uint256 _amount) public payable {
    uint256 ethAmount = convertToEth(_currencyCode, _amount);
    require(msg.value == ethAmount, "Sent ETH doesn't match the converted amount");
    
    totalTipsReceived += ethAmount;
    tipperContributions[msg.sender] += ethAmount;
    tipsPerCurrency[_currencyCode] += _amount;
}
```

### 提取小费
```solidity
function withdrawTips() public onlyOwner {
    uint256 contractBalance = address(this).balance;
    require(contractBalance > 0, "No tips to withdraw");
    
    (bool success, ) = payable(owner).call{value: contractBalance}("");
    require(success, "Transfer failed");
}
```

### 转移所有权
```solidity
function transferOwnership(address _newOwner) public onlyOwner {
    require(_newOwner != address(0), "Invalid address");
    owner = _newOwner;
}
```

### 查询函数
```solidity
function getSupportedCurrencies() public view returns (string[] memory) {
    return supportedCurrencies;
}

function getContractBalance() public view returns (uint256) {
    return address(this).balance;
}

function getTipperContribution(address _tipper) public view returns (uint256) {
    return tipperContributions[_tipper];
}

function getTipsInCurrency(string memory _currencyCode) public view returns (uint256) {
    return tipsPerCurrency[_currencyCode];
}

function getConversionRate(string memory _currencyCode) public view returns (uint256) {
    return conversionRates[_currencyCode];
}
```

## 核心知识点

- **Wei单位**: 1 ETH = 10^18 wei
- `1 ether` 是Solidity中表示 10^18 wei 的便捷方式
- `keccak256()`: 用于比较字符串的哈希函数
- `payable`: 函数和地址需要此修饰符才能接收ETH
- `call{value: }("")`: 推荐的发送ETH方式
- `address(this).balance`: 合约的ETH余额
- 货币转换需要精确的数学计算
- 使用映射跟踪多维数据(按用户、按货币等)

