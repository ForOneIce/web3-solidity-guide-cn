<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignThis - 签名验证 - Solidity学习</title>
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Reenie+Beanie&family=Comic+Neue:ital,wght@0,400;0,700;1,400&family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <!-- Markdown渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --easy: #43AA8B;
            --medium: #F8961E;
            --hard: #E71D36;
            --expert: #7209B7;
            --warm-brown: #8B7355;
            --parchment: #F5F1E6;
            --vintage-blue: #6B8E9F;
            --warm-red: #C44536;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Comic Neue', cursive;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            color: var(--dark);
            line-height: 1.8;
            background-image: radial-gradient(#d0e3ff 1px, transparent 1px);
            background-size: 30px 30px;
        }
        
        .nav-bar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 10px;
            font-family: 'Comic Neue', cursive;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .back-btn:hover {
            background: var(--secondary);
            transform: translateX(-3px);
        }
        
        .nav-title {
            font-family: 'Gochi Hand', cursive;
            font-size: 1.3rem;
            color: var(--secondary);
        }
        
        .nav-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 5px 15px;
            border-radius: 8px;
            font-family: 'Comic Neue', cursive;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .nav-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .hero-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-top: 5px solid var(--accent);
        }
        
        .hero-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .hero-title {
            flex: 1;
            min-width: 250px;
        }
        
        .day-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 20px;
            border-radius: 15px;
            font-family: 'Gochi Hand', cursive;
            font-size: 1.2rem;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        h1 {
            font-family: 'Gochi Hand', cursive;
            font-size: 2.8rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .meta-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .difficulty-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            font-size: 1rem;
        }
        
        .tag {
            background: var(--light);
            padding: 5px 15px;
            border-radius: 15px;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-family: 'Gochi Hand', cursive;
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px dashed var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .key-points {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .key-point {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent);
        }
        
        .key-point-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .concept-card {
            background: linear-gradient(135deg, #e6f7ff, #d6f0ff);
            border-left: 5px solid var(--primary);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .concept-title {
            font-family: 'Gochi Hand', cursive;
            font-size: 1.4rem;
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        pre {
            background: #282c34;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            margin: 15px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        
        code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #f8f8f2;
        }
        
        .inline-code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Fira Code', monospace;
            color: var(--hard);
            font-size: 0.9em;
        }
        
        .navigation-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .nav-footer-btn {
            flex: 1;
            min-width: 200px;
            background: white;
            border: 3px solid var(--primary);
            padding: 20px;
            border-radius: 15px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-footer-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .nav-footer-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .nav-footer-title {
            font-family: 'Gochi Hand', cursive;
            font-size: 1.3rem;
        }        
        /* 参考答案模块样式 - 温暖治愈风格 */
        .answer-reference {
            position: relative;
            margin: 60px 0 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .envelope-container {
            position: relative;
            width: 340px;
            height: 240px;
            cursor: pointer;
            perspective: 1200px;
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 20px rgba(139, 115, 85, 0.2));
        }
        
        .envelope {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .envelope-front, .envelope-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .envelope-front {
            background: linear-gradient(135deg, #f9f3e9, #e8dfd1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #d4c9b8;
        }
        
        .envelope-flap {
            position: absolute;
            top: -70px;
            width: 0;
            height: 0;
            border-left: 170px solid transparent;
            border-right: 170px solid transparent;
            border-bottom: 70px solid #e8dfd1;
            z-index: 1;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        }
        
        .envelope-flap::after {
            content: "";
            position: absolute;
            top: 3px;
            left: -170px;
            width: 0;
            height: 0;
            border-left: 170px solid transparent;
            border-right: 170px solid transparent;
            border-bottom: 67px solid #f9f3e9;
        }
        
        .envelope-seal {
            position: absolute;
            bottom: 25px;
            right: 35px;
            width: 70px;
            height: 70px;
            background: radial-gradient(circle at 30% 30%, #C44536, #8B2E24);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
            border: 2px solid #A52A2A;
        }
        
        .seal-icon {
            color: #F5F1E6;
            font-size: 1.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .envelope-text {
            font-family: 'Reenie Beanie', cursive;
            font-size: 2.4rem;
            color: var(--warm-brown);
            z-index: 2;
            position: relative;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }
        
        .envelope-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(139, 115, 85, 0.05) 3px, transparent 3px),
                radial-gradient(circle at 85% 75%, rgba(139, 115, 85, 0.05) 3px, transparent 3px);
            background-size: 40px 40px;
            z-index: 0;
        }
        
        .envelope-back {
            background: linear-gradient(135deg, #f5f1e6, #e8dfd1);
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #d4c9b8;
        }
        
        .envelope-container:hover .envelope {
            transform: rotateY(10deg) translateY(-5px);
        }
        
        .envelope-container.open .envelope {
            transform: rotateY(180deg);
        }
        
        .envelope-hint {
            font-family: 'Gochi Hand', cursive;
            font-size: 1.3rem;
            color: var(--warm-brown);
            margin-top: 15px;
            opacity: 0.9;
            background: rgba(245, 241, 230, 0.7);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        /* 弹窗样式 */
        .answer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: rgba(107, 142, 159, 0.7);
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(3px);
        }
        
        .letter-container {
            width: 90%;
            max-width: 900px;
            height: 80vh;
            background: #F5F1E6;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(107, 142, 159, 0.4);
            overflow: hidden;
            transform: scale(0);
            transition: transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #d4c9b8;
        }
        
        .answer-modal.open .letter-container {
            transform: scale(1);
        }
        
        .letter-header {
            background: linear-gradient(135deg, #8B7355, #6B5A45);
            padding: 25px 30px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-bottom: 2px dashed #A5947A;
        }
        
        .letter-title {
            font-family: 'Reenie Beanie', cursive;
            font-size: 3rem;
            color: #F5F1E6;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 2px;
        }
        
        .letter-subtitle {
            color: rgba(245, 241, 230, 0.9);
            font-size: 1.3rem;
            font-family: 'Gochi Hand', cursive;
        }
        
        .close-letter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(245, 241, 230, 0.2);
            color: #F5F1E6;
            border: 1px solid rgba(245, 241, 230, 0.3);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .close-letter:hover {
            background: rgba(245, 241, 230, 0.3);
            transform: rotate(90deg);
        }
        
        .letter-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #F5F1E6;
            position: relative;
        }
        
        .letter-body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background-image: 
                linear-gradient(90deg, transparent 98%, rgba(139, 115, 85, 0.1) 98%),
                linear-gradient(rgba(139, 115, 85, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }
        
        /* MD内容样式 */
        .md-content {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .md-section {
            margin-bottom: 40px;
        }
        
        .md-section h1 {
            font-family: 'Reenie Beanie', cursive;
            font-size: 3rem;
            color: var(--warm-brown);
            margin-bottom: 20px;
            border-bottom: 2px dashed #A5947A;
            padding-bottom: 10px;
            text-align: center;
        }
        
        .md-section h2 {
            font-family: 'Reenie Beanie', cursive;
            font-size: 2.2rem;
            color: var(--warm-brown);
            margin: 30px 0 15px 0;
            position: relative;
            padding-left: 25px;
        }
        
        .md-section h2::before {
            content: "•";
            position: absolute;
            left: 0;
            top: 0;
            color: var(--warm-red);
            font-size: 2.5rem;
        }
        
        .md-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .md-tag {
            background: rgba(139, 115, 85, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--warm-brown);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        .md-highlight {
            background: rgba(107, 142, 159, 0.1);
            border-left: 5px solid var(--vintage-blue);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(107, 142, 159, 0.2);
        }
        
        .md-content pre {
            background: #2d2a2e;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #3a363b;
        }
        
        .md-content code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #f8f8f2;
        }
        
        .md-content .inline-code {
            background: rgba(139, 115, 85, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: var(--warm-brown);
            font-size: 0.9em;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        .md-content ul, .md-content ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }
        
        .md-content li {
            margin-bottom: 8px;
            line-height: 1.7;
        }
        
        .md-content blockquote {
            border-left: 4px solid var(--vintage-blue);
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #666;
            background: rgba(107, 142, 159, 0.05);
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        .md-content th, .md-content td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        .md-content th {
            background: linear-gradient(135deg, var(--warm-brown), #6B5A45);
            color: #F5F1E6;
            font-weight: bold;
            font-family: 'Gochi Hand', cursive;
            font-size: 1.1rem;
        }
        
        .md-content tr:nth-child(even) {
            background: rgba(139, 115, 85, 0.05);
        }
        
        /* Markdown容器样式 */
        #markdown-container {
            line-height: 1.8;
        }
        
        #markdown-container h3 {
            font-family: 'Reenie Beanie', cursive;
            font-size: 1.8rem;
            color: var(--warm-brown);
            margin: 25px 0 15px 0;
            position: relative;
            padding-left: 20px;
        }
        
        #markdown-container h3::before {
            content: "▸";
            position: absolute;
            left: 0;
            color: var(--vintage-blue);
            font-size: 1.5rem;
        }
        
        #markdown-container h4 {
            font-family: 'Gochi Hand', cursive;
            font-size: 1.4rem;
            color: var(--warm-brown);
            margin: 20px 0 12px 0;
        }
        
        #markdown-container p {
            margin-bottom: 15px;
            line-height: 1.8;
        }
        
        #markdown-container strong {
            color: var(--warm-brown);
            font-weight: bold;
        }
        
        #markdown-container a {
            color: var(--vintage-blue);
            text-decoration: underline;
            transition: color 0.3s;
        }
        
        #markdown-container a:hover {
            color: var(--warm-brown);
        }
        
        #markdown-container hr {
            border: none;
            border-top: 2px dashed #A5947A;
            margin: 30px 0;
        }
        
        #markdown-container img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Markdown代码块样式 */
        #markdown-container pre {
            background: #2d2d2d;
            border: 1px solid #3a363b;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        #markdown-container pre code {
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #f8f8f2;
            background: transparent;
            padding: 0;
            border: none;
            display: block;
            white-space: pre;
        }
        
        #markdown-container code:not(pre code) {
            background: rgba(139, 115, 85, 0.15);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            color: var(--warm-brown);
            font-size: 0.9em;
            border: 1px solid rgba(139, 115, 85, 0.3);
            font-weight: 500;
        }
        
        #markdown-container table code {
            background: rgba(139, 115, 85, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            color: var(--warm-brown);
            font-size: 0.85em;
            border: 1px solid rgba(139, 115, 85, 0.2);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .signature {
            text-align: right;
            margin-top: 40px;
            font-family: 'Reenie Beanie', cursive;
            font-size: 2rem;
            color: var(--warm-brown);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .hero-section {
                padding: 25px;
            }
            
            .section {
                padding: 20px;
            }
            
            .key-points {
                grid-template-columns: 1fr;
            }
            
            .envelope-container {
                width: 300px;
                height: 210px;
            }
            
            .envelope-flap {
                border-left: 150px solid transparent;
                border-right: 150px solid transparent;
                border-bottom: 60px solid #e8dfd1;
            }
            
            .envelope-flap::after {
                border-left: 150px solid transparent;
                border-right: 150px solid transparent;
                border-bottom: 57px solid #f9f3e9;
                left: -150px;
            }
            
            .envelope-text {
                font-size: 2rem;
            }
            
            .answer-modal {
                padding: 10px;
            }
            
            .letter-container {
                width: 95%;
                height: 85vh;
            }
            
            .letter-title {
                font-size: 2.2rem;
            }
            
            .md-section h1 {
                font-size: 2.2rem;
            }
            
            .md-section h2 {
                font-size: 1.8rem;
            }
        }
    
        /* 修复 GitHub 代码块样式 */
        .md-content .highlight {
            background: #2d2a2e !important;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #3a363b;
        }
        
        .md-content .highlight pre {
            background: transparent !important;
            padding: 0;
            margin: 0;
            border: none;
        }
        
        .md-content .highlight code,
        .md-content .highlight pre code,
        .md-content .highlight pre span,
        .md-content .highlight pre {
            color: #f8f8f2 !important;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* 确保所有代码块内的文本都可见 */
        .md-content .highlight pre * {
            color: #f8f8f2 !important;
        }
        
        /* GitHub 语法高亮类颜色修复 - 确保所有类都有颜色 */
        .md-content .highlight pre [class*="pl-"] {
            color: #f8f8f2 !important;
        }
        
        /* 特定类型的颜色优化 */
        .md-content .highlight .pl-c {   /* 注释 */
            color: #6a9955 !important;
        }
        
        .md-content .highlight .pl-s,    /* 字符串 */
        .md-content .highlight .pl-s1 {  /* 字符串 */
            color: #ce9178 !important;
        }
        
        .md-content .highlight .pl-k,    /* 关键字 */
        .md-content .highlight .pl-c1 {   /* 常量/关键字 */
            color: #569cd6 !important;
        }
        
        .md-content .highlight .pl-v,    /* 变量 */
        .md-content .highlight .pl-en {   /* 函数名 */
            color: #dcdcaa !important;
        }
        
        /* 确保所有未包裹的文本也可见 */
        .md-content .highlight pre {
            color: #f8f8f2 !important;
        }
        
        .md-content code:not(pre code) {
            background: rgba(139, 115, 85, 0.15) !important;
            color: var(--warm-brown) !important;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(139, 115, 85, 0.3);
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .md-content .markdown-heading .anchor {
            display: none;
        }

    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-left">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> 返回首页
            </a>
            <span class="nav-title">第19天 - 数字签名</span>
        </div>
        <div class="nav-right">
            <a href="#concepts" class="nav-btn">📚 核心概念</a>
            <a href="#code" class="nav-btn">💻 代码讲解</a>
            <a href="#practice" class="nav-btn">🎯 实践</a>
        </div>
    </div>

    <div class="container">
        <div class="hero-section">
            <div class="hero-header">
                <div class="hero-title">
                    <div class="day-badge">第 19 天 ✍️</div>
                    <h1>SignThis - 签名验证</h1>
                    <p class="subtitle">使用数字签名实现Gas高效的访问控制</p>
                </div>
                <div class="meta-tags">
                    <div class="difficulty-badge" style="background: var(--hard);">
                        🌳 高级
                    </div>
                    <span class="tag">签名</span>
                    <span class="tag">ecrecover</span>
                    <span class="tag">认证</span>
                    <span class="tag">Gas优化</span>
                </div>
            </div>
            
            <div class="key-points">
                <div class="key-point">
                    <div class="key-point-title">📌 学习目标</div>
                    <div>掌握数字签名验证和链下认证</div>
                </div>
                <div class="key-point">
                    <div class="key-point-title">🎯 核心技能</div>
                    <div>ecrecover、消息哈希、签名生成</div>
                </div>
                <div class="key-point">
                    <div class="key-point-title">⏱️ 预计时间</div>
                    <div>60分钟</div>
                </div>
                <div class="key-point">
                    <div class="key-point-title">🔥 难度系数</div>
                    <div>★★★★☆</div>
                </div>
            </div>
        </div>

        <div class="section" id="concepts">
            <h2 class="section-title">
                <i class="fas fa-lightbulb"></i> 核心概念详解
            </h2>
            
            <div class="concept-card">
                <div class="concept-title">🔐 数字签名原理</div>
                <p>数字签名基于椭圆曲线密码学，提供身份验证和消息完整性：</p>
                <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong style="color: #856404;">🔹 签名过程</strong>
                    <ol style="margin-left: 20px; margin-top: 10px; color: #856404;">
                        <li>用户使用私钥对消息哈希进行签名</li>
                        <li>生成签名 (r, s, v) 三个参数</li>
                        <li>将签名和消息一起发送</li>
                    </ol>
                </div>
                <div style="background: #e6f7ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong style="color: #0066cc;">🔹 验证过程</strong>
                    <ol style="margin-left: 20px; margin-top: 10px; color: #0066cc;">
                        <li>合约接收消息和签名</li>
                        <li>使用ecrecover恢复签名者地址</li>
                        <li>验证地址是否有权限</li>
                    </ol>
                </div>
                <p><strong>优势：</strong>无需在链上存储白名单，节省Gas费用</p>
            </div>

            <div class="concept-card">
                <div class="concept-title">🔍 ecrecover 函数</div>
                <p><code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code>是Solidity内置函数，用于从签名恢复签名者地址：</p>
                <pre><code class="language-solidity">function ecrecover(bytes32 hash, uint8 v, bytes32 r, bytes32 s) 
    returns (address signer)</code></pre>
                <p><strong>参数说明：</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li><code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">hash</code>: 消息的keccak256哈希</li>
                    <li><code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">v</code>: 恢复ID (通常是27或28)</li>
                    <li><code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">r, s</code>: 签名的两个组成部分</li>
                </ul>
                <pre><code class="language-solidity">// 使用示例
bytes32 messageHash = keccak256(abi.encodePacked(user, eventId));
bytes32 ethSignedMessageHash = keccak256(abi.encodePacked("\x19Ethereum Signed Message:\n32", messageHash));
address signer = ecrecover(ethSignedMessageHash, v, r, s);</code></pre>
            </div>

            <div class="concept-card">
                <div class="concept-title">📝 以太坊签名消息格式</div>
                <p>以太坊钱包签名时会自动添加前缀，防止签名重放攻击：</p>
                <pre><code class="language-solidity">// 原始消息哈希
bytes32 messageHash = keccak256(abi.encodePacked(data));

// 以太坊签名消息哈希
bytes32 ethSignedMessageHash = keccak256(abi.encodePacked(
    "\x19Ethereum Signed Message:\n32", 
    messageHash
));</code></pre>
                <p><strong>前缀作用：</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>防止用户误签交易数据</li>
                    <li>区分不同类型的签名</li>
                    <li>提高安全性</li>
                </ul>
            </div>

            <div class="concept-card">
                <div class="concept-title">⚡ Gas优化策略</div>
                <p>基于签名的访问控制相比传统白名单有显著的Gas优势：</p>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong style="color: #155724;">✅ 签名方式</strong>
                    <ul style="margin-left: 20px; margin-top: 10px; color: #155724;">
                        <li>无需存储用户列表</li>
                        <li>验证成本固定 (~3000 gas)</li>
                        <li>支持无限用户</li>
                        <li>动态权限管理</li>
                    </ul>
                </div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong style="color: #721c24;">❌ 传统白名单</strong>
                    <ul style="margin-left: 20px; margin-top: 10px; color: #721c24;">
                        <li>每个用户需要存储 (~20000 gas)</li>
                        <li>查询成本随用户增加</li>
                        <li>修改白名单需要交易</li>
                        <li>存储成本高</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section" id="code">
            <h2 class="section-title">
                <i class="fas fa-code"></i> 完整代码详解
            </h2>
            
            <h3 style="color: var(--secondary); margin: 20px 0;">📄 签名验证活动合约</h3>
            <pre><code class="language-solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SignThis {
    string public eventName;
    address public organizer;
    uint256 public eventDate;
    uint256 public maxAttendees;
    uint256 public attendeeCount;
    bool public isEventActive;
    
    mapping(address => bool) public hasAttended;
    
    event EventCreated(string name, uint256 date, uint256 maxAttendees);
    event AttendeeCheckedIn(address attendee, uint256 timestamp);
    event EventStatusChanged(bool isActive);
    
    constructor(string memory _eventName, uint256 _eventDate, uint256 _maxAttendees) {
        eventName = _eventName;
        organizer = msg.sender;
        eventDate = _eventDate;
        maxAttendees = _maxAttendees;
        isEventActive = true;
        
        emit EventCreated(_eventName, _eventDate, _maxAttendees);
    }
    
    modifier onlyOrganizer() {
        require(msg.sender == organizer, "Only organizer");
        _;
    }
    
    modifier eventActive() {
        require(isEventActive, "Event not active");
        _;
    }
    
    // 使用签名验证参与者身份
    function checkInWithSignature(
        address attendee,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external eventActive {
        require(attendeeCount < maxAttendees, "Event full");
        require(!hasAttended[attendee], "Already checked in");
        
        // 构造消息哈希
        bytes32 messageHash = keccak256(abi.encodePacked(
            attendee,
            address(this),  // 合约地址
            eventName
        ));
        
        // 以太坊签名消息哈希
        bytes32 ethSignedMessageHash = keccak256(abi.encodePacked(
            "\x19Ethereum Signed Message:\n32",
            messageHash
        ));
        
        // 恢复签名者地址
        address signer = ecrecover(ethSignedMessageHash, v, r, s);
        
        // 验证签名者是组织者
        require(signer == organizer, "Invalid signature");
        
        // 记录参与
        hasAttended[attendee] = true;
        attendeeCount++;
        
        emit AttendeeCheckedIn(attendee, block.timestamp);
    }
    
    // 批量签到 (Gas优化)
    function batchCheckIn(
        address[] calldata attendees,
        uint8[] calldata v,
        bytes32[] calldata r,
        bytes32[] calldata s
    ) external eventActive {
        require(attendees.length == v.length, "Array length mismatch");
        require(attendees.length == r.length, "Array length mismatch");
        require(attendees.length == s.length, "Array length mismatch");
        require(attendeeCount + attendees.length <= maxAttendees, "Would exceed capacity");
        
        for (uint256 i = 0; i < attendees.length; i++) {
            address attendee = attendees[i];
            
            if (hasAttended[attendee]) continue;  // 跳过已签到的
            
            bytes32 messageHash = keccak256(abi.encodePacked(
                attendee,
                address(this),
                eventName
            ));
            
            bytes32 ethSignedMessageHash = keccak256(abi.encodePacked(
                "\x19Ethereum Signed Message:\n32",
                messageHash
            ));
            
            address signer = ecrecover(ethSignedMessageHash, v[i], r[i], s[i]);
            
            if (signer == organizer) {
                hasAttended[attendee] = true;
                attendeeCount++;
                emit AttendeeCheckedIn(attendee, block.timestamp);
            }
        }
    }
    
    // 验证签名有效性 (不执行签到)
    function verifySignature(
        address attendee,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external view returns (bool) {
        bytes32 messageHash = keccak256(abi.encodePacked(
            attendee,
            address(this),
            eventName
        ));
        
        bytes32 ethSignedMessageHash = keccak256(abi.encodePacked(
            "\x19Ethereum Signed Message:\n32",
            messageHash
        ));
        
        address signer = ecrecover(ethSignedMessageHash, v, r, s);
        return signer == organizer;
    }
    
    // 获取消息哈希 (用于前端签名)
    function getMessageHash(address attendee) external view returns (bytes32) {
        return keccak256(abi.encodePacked(
            attendee,
            address(this),
            eventName
        ));
    }
    
    // 管理员功能
    function toggleEventStatus() external onlyOrganizer {
        isEventActive = !isEventActive;
        emit EventStatusChanged(isEventActive);
    }
    
    function getEventInfo() external view returns (
        string memory name,
        uint256 date,
        uint256 maxCapacity,
        uint256 currentCount,
        bool active
    ) {
        return (eventName, eventDate, maxAttendees, attendeeCount, isEventActive);
    }
}</code></pre>

            <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border-left: 5px solid #28a745; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <strong style="color: #155724;">✅ 签名验证流程</strong>
                <p style="margin-top: 10px; color: #155724;">
                    1. 组织者链下生成参与者签名 → 2. 参与者提交签名到合约 → 3. 合约使用ecrecover验证签名 → 4. 验证通过则允许签到。整个过程无需预先存储白名单！
                </p>
            </div>

            <h3 style="color: var(--secondary); margin: 30px 0 20px 0;">🔍 前端签名生成示例</h3>
            <pre><code class="language-javascript">// JavaScript 前端代码
async function generateSignature(attendeeAddress, contractAddress, eventName) {
    // 1. 构造消息
    const messageHash = ethers.utils.solidityKeccak256(
        ['address', 'address', 'string'],
        [attendeeAddress, contractAddress, eventName]
    );
    
    // 2. 组织者签名
    const signature = await organizerWallet.signMessage(
        ethers.utils.arrayify(messageHash)
    );
    
    // 3. 分离签名组件
    const { v, r, s } = ethers.utils.splitSignature(signature);
    
    return { v, r, s };
}

// 使用示例
const signature = await generateSignature(
    "0x742d35Cc6634C0532925a3b8D0C9964E5Bd4f071",  // 参与者地址
    contractAddress,
    "Web3 Conference 2024"
);

// 调用合约签到
await contract.checkInWithSignature(
    attendeeAddress,
    signature.v,
    signature.r,
    signature.s
);</code></pre>

            <div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <strong style="color: #856404;">⚠️ 安全注意事项</strong>
                <p style="margin-top: 10px; color: #856404;">
                    - 签名可能被重放，需要添加nonce或时间戳<br>
                    - 确保消息哈希包含足够的上下文信息<br>
                    - 验证签名者身份的权威性<br>
                    - 考虑签名的有效期限制<br>
                    - 防止签名被用于其他合约
                </p>
            </div>
        </div>

        <div class="section" id="practice">
            <h2 class="section-title">
                <i class="fas fa-dumbbell"></i> 实践与练习
            </h2>
            
            <h3 style="color: var(--secondary); margin-bottom: 20px;">📝 Remix实战步骤</h3>
            
            <div style="margin: 30px 0;">
                <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">步骤1: 部署合约</h4>
                <ol style="margin: 10px 0 10px 25px; line-height: 2;">
                    <li>部署SignThis合约，设置活动信息</li>
                    <li>记录合约地址和组织者地址</li>
                </ol>
            </div>

            <div style="margin: 30px 0;">
                <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">步骤2: 生成签名 (使用MetaMask)</h4>
                <ol style="margin: 10px 0 10px 25px; line-height: 2;">
                    <li>调用<code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">getMessageHash(参与者地址)</code>获取消息哈希</li>
                    <li>在浏览器控制台使用MetaMask签名：</li>
                </ol>
                <pre style="margin: 10px 0;"><code class="language-javascript">// 在浏览器控制台执行
const messageHash = "0x...";  // 从合约获取的哈希
const signature = await ethereum.request({
    method: "personal_sign",
    params: [messageHash, ethereum.selectedAddress]
});</code></pre>
            </div>

            <div style="margin: 30px 0;">
                <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">步骤3: 分离签名并验证</h4>
                <ol style="margin: 10px 0 10px 25px; line-height: 2;">
                    <li>使用在线工具或脚本分离签名的v, r, s</li>
                    <li>调用<code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">verifySignature</code>验证签名有效性</li>
                    <li>调用<code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">checkInWithSignature</code>完成签到</li>
                </ol>
            </div>

            <div style="margin: 30px 0;">
                <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">步骤4: 测试批量签到</h4>
                <ol style="margin: 10px 0 10px 25px; line-height: 2;">
                    <li>为多个地址生成签名</li>
                    <li>调用<code class="inline-code" style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">batchCheckIn</code>批量处理</li>
                    <li>观察Gas消耗对比</li>
                </ol>
            </div>

            <h3 style="color: var(--secondary); margin: 40px 0 20px 0;">🎯 挑战练习</h3>
            <div style="background: linear-gradient(135deg, #fff9e6, #ffedd5); border-left: 5px solid var(--medium); padding: 25px; border-radius: 10px;">
                <p style="font-weight: bold; margin-bottom: 15px; font-size: 1.1rem;">尝试以下改进:</p>
                <ol style="margin-left: 25px; line-height: 2.2;">
                    <li>添加nonce防止签名重放攻击</li>
                    <li>实现签名有效期机制</li>
                    <li>创建多级权限系统 (组织者、志愿者、参与者)</li>
                    <li>实现签名撤销功能</li>
                    <li>添加签名使用次数限制</li>
                    <li>创建基于签名的投票系统</li>
                </ol>
            </div>

            <h3 style="color: var(--secondary); margin: 40px 0 20px 0;">📚 扩展知识</h3>
            
            <div style="background: white; border: 2px solid var(--accent); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h4 style="color: var(--primary); margin-bottom: 10px;">EIP-712 结构化签名</h4>
                <pre><code class="language-solidity">// EIP-712 提供更安全的结构化签名
struct Permit {
    address owner;
    address spender;
    uint256 value;
    uint256 nonce;
    uint256 deadline;
}

bytes32 constant PERMIT_TYPEHASH = keccak256(
    "Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"
);</code></pre>
                <p style="margin-top: 10px;">EIP-712提供了更安全、用户友好的签名方式，被广泛用于DeFi协议。</p>
            </div>

            <div style="background: white; border: 2px solid var(--accent); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h4 style="color: var(--primary); margin-bottom: 10px;">签名应用场景对比</h4>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <tr style="background: var(--light);">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--accent);">应用</th>
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--accent);">优势</th>
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--accent);">适用场景</th>
                    </tr>
                    <tr>
                        <td style="padding: 10px;">白名单验证</td>
                        <td style="padding: 10px;">Gas高效</td>
                        <td style="padding: 10px;">NFT铸造、活动签到</td>
                    </tr>
                    <tr style="background: #f8f9fa;">
                        <td style="padding: 10px;">元交易</td>
                        <td style="padding: 10px;">用户无需ETH</td>
                        <td style="padding: 10px;">DApp用户体验</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;">Permit授权</td>
                        <td style="padding: 10px;">一步完成授权</td>
                        <td style="padding: 10px;">DeFi协议集成</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="navigation-footer">
            <a href="contract-18.html" class="nav-footer-btn" style="border-color: var(--accent);">
                <div class="nav-footer-label">← 上一个</div>
                <div class="nav-footer-title">Oracle - 预言机合约</div>
            </a>
            <a href="contract-20.html" class="nav-footer-btn" style="border-color: var(--accent);">
                <div class="nav-footer-label">下一个 →</div>
                <div class="nav-footer-title">FortKnox - 金库堡垒</div>
            </a>
        </div>
    
        <!-- Sneha的一封来信模块 -->
        <div class="answer-reference">
            <div class="envelope-container" id="envelope-container">
                <div class="envelope">
                    <div class="envelope-front">
                        <div class="envelope-flap"></div>
                        <div class="envelope-pattern"></div>
                        <div class="envelope-seal">
                            <i class="fas fa-feather-alt seal-icon"></i>
                        </div>
                        <div class="envelope-text">Sneha的一封来信</div>
                    </div>
                    <div class="envelope-back">
                        <div class="envelope-text" style="color: var(--warm-brown);">点击开启</div>
                    </div>
                </div>
            </div>
            <div class="envelope-hint">点击信封查看Sneha的来信</div>
        </div>
    </div>

    <!-- 弹窗 - 内容待后续精细化处理 -->
    <div class="answer-modal" id="answer-modal">
        <div class="letter-container">
            <div class="letter-header">
                <div class="letter-title">Sneha的一封来信</div>
                <div class="letter-subtitle">关于第19天的学习指导</div>
                <button id="close-letter" class="close-letter">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="letter-body">
                <div id="md-content" class="md-content">
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">签名验证</h1></div>
<p dir="auto">Day: Day 19
ID: 19
译者: 雷雷
难度等级: 中级</p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">学习内容</h1></div>
<p dir="auto">好吧——到目前为止，我们在 Solidity 之旅中取得了一些重大进展。
我们学会了如何：</p>
<ul dir="auto">
<li>分配<strong>所有权</strong></li>
<li>使用<strong>修饰符</strong>保护函数</li>
<li>使用<strong>映射</strong>来存储用户数据</li>
<li>进行全面的<strong>代币销售</strong></li>
<li>使用<strong>委托调用</strong>构建基于插件的模块化系统</li>
</ul>
<p dir="auto">但现在，是时候将<strong>所有这些技能付诸行动</strong>并解决现实世界的问题了——这是每个 Web3 构建者都能与之相关的。</p>
<p dir="auto"><strong>场景  ：私人 Web3 事件</strong>
你正在组织代币<strong>门控会议</strong>、<strong>创始人聚会</strong>或<strong>链上研讨会</strong>。只有选定的客人才能进入。
现在挑战来了......</p>
<p dir="auto"><strong>传统方法：</strong>
你将每个与会者的地址存储在链上。
你可以在办理登机手续时手动检查每一项。
每次地址更新或拼写错误都会消耗 gas。
💢这很笨拙。太贵了。那不是 Web3。</p>
<p dir="auto"><strong>✅更智能的方式：链下签名</strong>
而不是上传一大堆地址......
如果：</p>
<ul dir="auto">
<li>活动组织者为每位获批的来宾签署一条消息</li>
<li>客人携带已签名的邀请函</li>
<li>合约只是在签到时验证签名</li>
<li>无需在链上存储任何白名单</li>
</ul>
<p dir="auto">是的，这一切都是使用以太坊内置的 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code> 功能安全地完成的。</p>
<p dir="auto"><strong>我们的游戏计划🌌</strong>
 以下是我们将要构建的内容，以及我们将如何分解它：
<strong>1. 活动设置</strong>
        组织者定义姓名、日期和最大与会者人数。
<strong>2.加密邀请</strong>
       后端不是存储地址，而是为每个已批准的来宾签署一条消息。
<strong>3.签到流程</strong>
       来宾提交他们签名的消息。
该合同使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code> 来验证它是否由组织者签署。
<strong>4.安全性和灵活性</strong>
        链上没有地址列表。没有预加载的白名单。没有浪费的气体。
只有有效的、签名的与会者才能进入——而且这一切都可以在链上完全验证。</p>
<p dir="auto"><strong>您将学到什么</strong>
如何对结构化数据进行哈希处理  （<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">abi.encodePacked</code>）
为什么以太坊使用签名消息前缀
<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover（）</code> 如何让你在链上验证链下批准
如何实施当今生产中实际使用的轻量级、节能的访问系统</p>
<p dir="auto">由此可见，在传统的活动管理系统中，身份验证往往依赖于中心化的数据库和复杂的权限控制机制。参与者需要注册账户、记住密码，组织者需要维护用户列表、处理忘记密码等繁琐事务。这种模式不仅用户体验复杂，还存在单点故障和数据泄露的风险。</p>
<p dir="auto"><strong>区块链技术为我们提供了一种全新的思路</strong>：通过密码学证明而非中心化授权来验证身份。本「签名验证活动合约」正是这一理念的实践——利用数字签名技术，构建了一个去中心化、安全高效的活动管理系统。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>🎯 设计哲学</strong></h3></div>
<p dir="auto">本合约的核心创新在于&nbsp;<strong>"链下签名，链上验证"</strong>&nbsp;的模式：</p>
<ul dir="auto">
<li><strong>组织者</strong>在链下为合法参与者生成数字签名</li>
<li><strong>参与者</strong>提交签名到区块链合约进行验证</li>
<li><strong>智能合约</strong>通过<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code>函数恢复签名者地址，确认身份有效性</li>
</ul>
<p dir="auto">这种方法带来了多重优势：</p>
<ul dir="auto">
<li><strong>零Gas预注册</strong>：参与者无需预先支付Gas费注册</li>
<li><strong>无限扩展性</strong>：签名生成不受区块链吞吐量限制</li>
<li><strong>隐私保护</strong>：参与者名单不会全部暴露在链上</li>
<li><strong>成本优化</strong>：批量签到大幅降低Gas消耗</li>
</ul>
<p dir="auto"><strong>学习目标</strong>：掌握数字签名验证和链下认证</p>
<p dir="auto"><strong>核心技能</strong>：ecrecover、消息哈希、签名生成</p>
<p dir="auto"><strong>完整代码</strong>：‣</p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">1、产品需求书</h1></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>a.用户路径图</strong></h3></div>
<p dir="auto"><strong>组织者路径organizer</strong></p>
<ol dir="auto">
<li><strong>合约部署</strong>
<ul dir="auto">
<li>调用构造函数，传入活动参数</li>
<li>自动成为organizer，获得管理权限</li>
</ul>
</li>
<li><strong>签名生成</strong>
<ul dir="auto">
<li>获取参与者钱包地址</li>
<li>调用getMessageHash获取消息哈希</li>
<li>使用私钥对哈希进行签名</li>
<li>分离签名为v, r, s组件</li>
</ul>
</li>
<li><strong>批量管理</strong>
<ul dir="auto">
<li>为多个参与者生成签名</li>
<li>使用batchCheckIn进行批量签到</li>
<li>监控活动状态和参与人数</li>
</ul>
</li>
</ol>
<p dir="auto"><strong>参与者路径Attendee</strong></p>
<ol dir="auto">
<li><strong>活动发现</strong>
<ul dir="auto">
<li>查看活动基本信息</li>
<li>确认活动状态(isEventActive)</li>
</ul>
</li>
<li><strong>签到流程</strong>
<ul dir="auto">
<li>从组织者获取签名数据</li>
<li>提交v, r, s参数到合约</li>
<li>等待签名验证和状态更新</li>
</ul>
</li>
<li><strong>状态确认</strong>
<ul dir="auto">
<li>验证hasAttended状态</li>
<li>查看签到历史记录</li>
</ul>
</li>
</ol>
<p dir="auto"><img src="../Notes/Notes_Herstory/签名验证 28c06421268880a1a3b5d1d75cf53398/image.png" alt="用户路径图 - 签名验证活动流程" style="max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin: 20px 0;"></p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>b.数据库结构</strong></h3></div>
<p dir="auto"><strong>1.合约基本信息（Contract Basic Information）</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>Contract / 合约</strong></th>
<th><strong>Type / 类型</strong></th>
<th><strong>Bases / 基础合约</strong></th>
<th><strong>含义 / Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>SignThis</td>
<td>Implementation / 实现合约</td>
<td>None / 无</td>
<td>签名验证活动合约 / Signature Verification Event Contract</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>2.状态变量表 (State Variables Table)</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>L</strong></th>
<th><strong>Field Name / 字段名</strong></th>
<th><strong>Visibility / 可见性</strong></th>
<th><strong>Mutability / 可变性</strong></th>
<th><strong>Data Type / 数据类型</strong></th>
<th><strong>Description / 描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>L</td>
<td>eventName</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>string / 字符串</td>
<td>活动名称 / Event Name</td>
</tr>
<tr>
<td>L</td>
<td>organizer</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>address / 地址</td>
<td>组织者钱包地址 / Organizer Wallet Address</td>
</tr>
<tr>
<td>L</td>
<td>eventDate</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>uint256 / 无符号整数</td>
<td>活动日期时间戳 / Event Date Timestamp</td>
</tr>
<tr>
<td>L</td>
<td>maxAttendees</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>uint256 / 无符号整数</td>
<td>最大参与人数 / Maximum Attendee Capacity</td>
</tr>
<tr>
<td>L</td>
<td>attendeeCount</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>uint256 / 无符号整数</td>
<td>当前参与人数 / Current Attendee Count</td>
</tr>
<tr>
<td>L</td>
<td>isEventActive</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>bool / 布尔值</td>
<td>活动是否激活 / Whether Event is Active</td>
</tr>
<tr>
<td>L</td>
<td>hasAttended</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>mapping(address ⇒ bool) / 映射</td>
<td>参与记录映射表 / Attendance Record Mapping</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>3. 函数接口表 (Function Interfaces Table)</strong></h3></div>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>L</strong></th>
<th><strong>Function Name / 函数名</strong></th>
<th><strong>Visibility / 可见性</strong></th>
<th><strong>Mutability / 可变性</strong></th>
<th><strong>Modifiers / 修饰器</strong></th>
<th><strong>Description / 描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>L</td>
<td>constructor</td>
<td>Internal / 内部</td>
<td>state-changing / 状态修改</td>
<td>NO / 无</td>
<td>合约构造函数 / Contract Constructor</td>
</tr>
<tr>
<td>L</td>
<td>checkInWithSignature</td>
<td>Public / 公开</td>
<td>state-changing / 状态修改</td>
<td>eventActive</td>
<td>单用户签名验证签到 / Single User Signature Check-in</td>
</tr>
<tr>
<td>L</td>
<td>batchCheckIn</td>
<td>Public / 公开</td>
<td>state-changing / 状态修改</td>
<td>eventActive</td>
<td>批量签名验证签到 / Batch Signature Check-in</td>
</tr>
<tr>
<td>L</td>
<td>verifySignature</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>NO / 无</td>
<td>验证签名有效性 / Verify Signature Validity</td>
</tr>
<tr>
<td>L</td>
<td>getMessageHash</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>NO / 无</td>
<td>获取消息哈希值 / Get Message Hash for Signing</td>
</tr>
<tr>
<td>L</td>
<td>toggleEventStatus</td>
<td>Public / 公开</td>
<td>state-changing / 状态修改</td>
<td>onlyOrganizer</td>
<td>切换活动状态 / Toggle Event Status</td>
</tr>
<tr>
<td>L</td>
<td>getEventInfo</td>
<td>Public / 公开</td>
<td>view / 只读</td>
<td>NO / 无</td>
<td>获取活动完整信息 / Get Complete Event Information</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>补充说明：</strong></p>
<p dir="auto"><strong>修饰器表 (Modifiers Table)</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>L</strong></th>
<th><strong>Modifier Name / 修饰器名</strong></th>
<th><strong>Description / 描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>L</td>
<td>onlyOrganizer</td>
<td>仅组织者可调用 / Only Organizer Can Call</td>
</tr>
<tr>
<td>L</td>
<td>eventActive</td>
<td>仅活动激活状态可调用 / Only When Event is Active</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>事件日志表 (Event Logs Table)</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>L</strong></th>
<th><strong>Event Name / 事件名</strong></th>
<th><strong>Parameters / 参数</strong></th>
<th><strong>Description / 描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>L</td>
<td>EventCreated</td>
<td>(string name, uint256 date, uint256 maxAttendees)</td>
<td>活动创建事件 / Event Created</td>
</tr>
<tr>
<td>L</td>
<td>AttendeeCheckedIn</td>
<td>(address attendee, uint256 timestamp)</td>
<td>参与者签到事件 / Attendee Checked In</td>
</tr>
<tr>
<td>L</td>
<td>EventStatusChanged</td>
<td>(bool isActive)</td>
<td>活动状态变更事件 / Event Status Changed</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>关键术语说明 (Key Terminology Explanation)</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>Term / 术语</strong></th>
<th><strong>Meaning / 含义</strong></th>
<th><strong>Description / 描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Visibility / 可见性</strong></td>
<td>访问权限控制</td>
<td>定义谁可以调用函数或访问变量 / Defines who can call functions or access variables</td>
</tr>
<tr>
<td><strong>Mutability / 可变性</strong></td>
<td>状态修改能力</td>
<td>view: 只读不修改状态; state-changing: 修改状态需要Gas费 / view: read-only; state-changing: modifies state and requires Gas</td>
</tr>
<tr>
<td><strong>Modifiers / 修饰器</strong></td>
<td>函数修饰条件</td>
<td>在函数执行前检查的条件 / Conditions checked before function execution</td>
</tr>
<tr>
<td><strong>Public / 公开</strong></td>
<td>完全公开访问</td>
<td>任何账户都可以调用 / Can be called by any account</td>
</tr>
<tr>
<td><strong>Internal / 内部</strong></td>
<td>内部访问</td>
<td>仅合约内部或其他继承合约可调用 / Only within contract or inherited contracts</td>
</tr>
<tr>
<td><strong>State-changing / 状态修改</strong></td>
<td>修改区块链状态</td>
<td>需要支付Gas费用，会产生交易 / Requires Gas fee and creates a transaction</td>
</tr>
<tr>
<td><strong>View / 只读</strong></td>
<td>仅读取状态</td>
<td>免费调用，不修改状态 / Free to call, does not modify state</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<p dir="auto"><strong>数据类型说明 (Data Types Explanation)</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th><strong>Data Type / 数据类型</strong></th>
<th><strong>Description / 描述</strong></th>
<th><strong>Example / 示例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>string / 字符串</td>
<td>文本数据类型 / Text data type</td>
<td>"Web3 Conference 2024"</td>
</tr>
<tr>
<td>address / 地址</td>
<td>以太坊账户地址 / Ethereum account address</td>
<td>0x742d35Cc6634C0532925a3b8D0C9964E5Bd4f071</td>
</tr>
<tr>
<td>uint256 / 无符号整数</td>
<td>256位正整数 / 256-bit positive integer</td>
<td>1735660800 (时间戳)</td>
</tr>
<tr>
<td>bool / 布尔值</td>
<td>真/假值 / True/False value</td>
<td>true / false</td>
</tr>
<tr>
<td>mapping / 映射</td>
<td>键值对存储 / Key-value storage</td>
<td>address → bool (地址到布尔值的映射)</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">2、细节详解</h1></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>核心概念</strong></h3></div>
<p dir="auto"><strong>（1）数字签名原理</strong>：数字签名基于椭圆曲线密码学，提供身份验证和消息完整性：</p>
<p dir="auto"><strong>🔹 签名过程</strong></p>
<ol dir="auto">
<li>用户使用私钥对消息哈希进行签名</li>
<li>生成签名 (r, s, v) 三个参数</li>
<li>将签名和消息一起发送</li>
</ol>
<p dir="auto"><strong>🔹 验证过程</strong></p>
<ol dir="auto">
<li>合约接收消息和签名</li>
<li>使用ecrecover恢复签名者地址</li>
<li>验证地址是否有权限</li>
</ol>
<p dir="auto">**优势：**无需在链上存储白名单，节省Gas费用</p>
<p dir="auto"><strong>🔍（2） ecrecover 函数</strong></p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code>是Solidity内置函数，用于从签名恢复签名者地址：</p>
<div class="highlight highlight-source-solidity notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function<span class="pl-en"> ecrecover</span></span>(<span class="pl-c1">bytes32</span> <span class="pl-v">hash</span>, <span class="pl-c1">uint8</span> <span class="pl-v">v</span>, <span class="pl-c1">bytes32</span> <span class="pl-v">r</span>, <span class="pl-c1">bytes32</span> <span class="pl-v">s</span>)
    <span class="pl-k">returns</span> (<span class="pl-c1">address</span> <span class="pl-v">signer</span>)</pre></div>
<p dir="auto"><strong>参数说明：</strong></p>
<ul dir="auto">
<li><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">hash</code>: 消息的keccak256哈希</li>
<li><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">v</code>: 恢复ID (通常是27或28)</li>
<li><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">r, s</code>: 签名的两个组成部分</li>
</ul>
<div class="highlight highlight-source-solidity notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// 使用示例</span>
<span class="pl-c1">bytes32</span> messageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(user, eventId));
<span class="pl-c1">bytes32</span> ethSignedMessageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(<span class="pl-s">"<span class="pl-s">\x19Ethereum Signed Message:\n32</span>"</span>, messageHash));
<span class="pl-c1">address</span> signer <span class="pl-k">=</span> <span class="pl-c1">ecrecover</span>(ethSignedMessageHash, v, r, s);</pre></div>
<p dir="auto">📝 （3）<strong>以太坊签名消息格式</strong></p>
<p dir="auto">以太坊钱包签名时会自动添加前缀，防止签名重放攻击：</p>
<div class="highlight highlight-source-solidity notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// 原始消息哈希</span>
<span class="pl-c1">bytes32</span> messageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(data));

<span class="pl-c">// 以太坊签名消息哈希</span>
<span class="pl-c1">bytes32</span> ethSignedMessageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
    <span class="pl-s">"<span class="pl-s">\x19Ethereum Signed Message:\n32</span>"</span>,
    messageHash
));</pre></div>
<p dir="auto"><strong>前缀作用：</strong></p>
<ul dir="auto">
<li>防止用户误签交易数据</li>
<li>区分不同类型的签名</li>
<li>提高安全性</li>
</ul>
<p dir="auto">⚡ Gas优化策略</p>
<p dir="auto">基于签名的访问控制相比传统白名单有显著的Gas优势：</p>
<p dir="auto"><strong>✅ 签名方式</strong></p>
<ul dir="auto">
<li>无需存储用户列表</li>
<li>验证成本固定 (~3000 gas)</li>
<li>支持无限用户</li>
<li>动态权限管理</li>
</ul>
<p dir="auto"><strong>❌ 传统白名单</strong></p>
<ul dir="auto">
<li>每个用户需要存储 (~20000 gas)</li>
<li>查询成本随用户增加</li>
<li>修改白名单需要交易</li>
<li>存储成本高</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>分解代码</strong></h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>拆解的合约：<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">EventEntry.sol</code></strong></h3></div>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// SPDX-License-Identifier: MIT</span>
<span class="pl-s1">pragma</span> <span class="pl-s1">solidity</span> <span class="pl-c1">^</span><span class="pl-c1">0.8</span><span class="pl-c1">.17</span><span class="pl-kos">;</span>

<span class="pl-s1">contract</span> <span class="pl-v">EventEntry</span> <span class="pl-kos">{</span>
    <span class="pl-s1">string</span> <span class="pl-s1">public</span> <span class="pl-s1">eventName</span><span class="pl-kos">;</span>
    <span class="pl-s1">address</span> <span class="pl-s1">public</span> <span class="pl-s1">organizer</span><span class="pl-kos">;</span>
    <span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">eventDate</span><span class="pl-kos">;</span>
    <span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">;</span>
    <span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">attendeeCount</span><span class="pl-kos">;</span>
    <span class="pl-s1">bool</span> <span class="pl-s1">public</span> <span class="pl-s1">isEventActive</span><span class="pl-kos">;</span>

    <span class="pl-en">mapping</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-c1">=&gt;</span> <span class="pl-s1">bool</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">hasAttended</span><span class="pl-kos">;</span>

    <span class="pl-s1">event</span><span class="pl-kos"></span> <span class="pl-v">EventCreated</span><span class="pl-kos">(</span><span class="pl-s1">string</span> <span class="pl-s1">name</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">date</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-s1">event</span><span class="pl-kos"></span> <span class="pl-v">AttendeeCheckedIn</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-s1">attendee</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">timestamp</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-s1">event</span><span class="pl-kos"></span> <span class="pl-v">EventStatusChanged</span><span class="pl-kos">(</span><span class="pl-s1">bool</span> <span class="pl-s1">isActive</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

    <span class="pl-en">constructor</span><span class="pl-kos">(</span><span class="pl-s1">string</span> <span class="pl-s1">memory</span> <span class="pl-s1">_eventName</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">)</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
        <span class="pl-s1">eventName</span> <span class="pl-c1">=</span> <span class="pl-s1">_eventName</span><span class="pl-kos">;</span>
        <span class="pl-s1">eventDate</span> <span class="pl-c1">=</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">;</span>
        <span class="pl-s1">maxAttendees</span> <span class="pl-c1">=</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">;</span>
        <span class="pl-s1">organizer</span> <span class="pl-c1">=</span> <span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">;</span>
        <span class="pl-s1">isEventActive</span> <span class="pl-c1">=</span> <span class="pl-c1">true</span><span class="pl-kos">;</span>

        <span class="pl-s1">emit</span><span class="pl-kos"></span> <span class="pl-v">EventCreated</span><span class="pl-kos">(</span><span class="pl-s1">_eventName</span><span class="pl-kos">,</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">,</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-s1">modifier</span><span class="pl-kos"></span> <span class="pl-en">onlyOrganizer</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span> <span class="pl-c1">==</span> <span class="pl-s1">organizer</span><span class="pl-kos">,</span> <span class="pl-s">"Only the event organizer can call this function"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-s1">_</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">function</span> <span class="pl-en">setEventStatus</span><span class="pl-kos">(</span><span class="pl-s1">bool</span> <span class="pl-s1">_isActive</span><span class="pl-kos">)</span> <span class="pl-s1">external</span> <span class="pl-s1">onlyOrganizer</span> <span class="pl-kos">{</span>
        <span class="pl-s1">isEventActive</span> <span class="pl-c1">=</span> <span class="pl-s1">_isActive</span><span class="pl-kos">;</span>
        <span class="pl-s1">emit</span><span class="pl-kos"></span> <span class="pl-v">EventStatusChanged</span><span class="pl-kos">(</span><span class="pl-s1">_isActive</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">function</span> <span class="pl-en">getMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-s1">_attendee</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">view</span> <span class="pl-s1">returns</span> <span class="pl-kos">(</span><span class="pl-s1">bytes32</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
        <span class="pl-k">return</span> <span class="pl-en">keccak256</span><span class="pl-kos">(</span><span class="pl-s1">abi</span><span class="pl-kos">.</span><span class="pl-en">encodePacked</span><span class="pl-kos">(</span><span class="pl-en">address</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">)</span><span class="pl-kos">,</span> <span class="pl-s1">eventName</span><span class="pl-kos">,</span> <span class="pl-s1">_attendee</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">function</span> <span class="pl-en">getEthSignedMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">bytes32</span> <span class="pl-s1">_messageHash</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">pure</span> <span class="pl-s1">returns</span> <span class="pl-kos">(</span><span class="pl-s1">bytes32</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
        <span class="pl-k">return</span> <span class="pl-en">keccak256</span><span class="pl-kos">(</span><span class="pl-s1">abi</span><span class="pl-kos">.</span><span class="pl-en">encodePacked</span><span class="pl-kos">(</span><span class="pl-s">"\x19Ethereum Signed Message:\n32"</span><span class="pl-kos">,</span> <span class="pl-s1">_messageHash</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">function</span> <span class="pl-en">verifySignature</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-s1">_attendee</span><span class="pl-kos">,</span> <span class="pl-s1">bytes</span> <span class="pl-s1">memory</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">view</span> <span class="pl-s1">returns</span> <span class="pl-kos">(</span><span class="pl-s1">bool</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
        <span class="pl-s1">bytes32</span> <span class="pl-s1">messageHash</span> <span class="pl-c1">=</span> <span class="pl-en">getMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">_attendee</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-s1">bytes32</span> <span class="pl-s1">ethSignedMessageHash</span> <span class="pl-c1">=</span> <span class="pl-en">getEthSignedMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">messageHash</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-k">return</span> <span class="pl-en">recoverSigner</span><span class="pl-kos">(</span><span class="pl-s1">ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-c1">==</span> <span class="pl-s1">organizer</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">function</span> <span class="pl-s1">recoverSigner</span><span class="pl-kos">(</span><span class="pl-s1">bytes32</span> <span class="pl-s1">_ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">bytes</span> <span class="pl-s1">memory</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span>
        <span class="pl-s1">public</span>
        <span class="pl-s1">pure</span>
        <span class="pl-en">returns</span> <span class="pl-kos">(</span><span class="pl-s1">address</span><span class="pl-kos">)</span>
    <span class="pl-kos">{</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">.</span><span class="pl-c1">length</span> <span class="pl-c1">==</span> <span class="pl-c1">65</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature length"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

        <span class="pl-s1">bytes32</span> <span class="pl-s1">r</span><span class="pl-kos">;</span>
        <span class="pl-s1">bytes32</span> <span class="pl-s1">s</span><span class="pl-kos">;</span>
        <span class="pl-s1">uint8</span> <span class="pl-s1">v</span><span class="pl-kos">;</span>

        <span class="pl-s1">assembly</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
            <span class="pl-s1">r</span> :<span class="pl-c1">=</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">32</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
            <span class="pl-s1">s</span> :<span class="pl-c1">=</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">64</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
            <span class="pl-s1">v</span> :<span class="pl-c1">=</span> <span class="pl-en">byte</span><span class="pl-kos">(</span><span class="pl-c1">0</span><span class="pl-kos">,</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">96</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
        <span class="pl-kos">}</span>

        <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-s1">v</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">27</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
            <span class="pl-s1">v</span> <span class="pl-c1">+=</span> <span class="pl-c1">27</span><span class="pl-kos">;</span>
        <span class="pl-kos">}</span>

        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">v</span> <span class="pl-c1">==</span> <span class="pl-c1">27</span> <span class="pl-c1">||</span> <span class="pl-s1">v</span> <span class="pl-c1">==</span> <span class="pl-c1">28</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature 'v' value"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

        <span class="pl-k">return</span> <span class="pl-en">ecrecover</span><span class="pl-kos">(</span><span class="pl-s1">_ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">v</span><span class="pl-kos">,</span> <span class="pl-s1">r</span><span class="pl-kos">,</span> <span class="pl-s1">s</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">function</span> <span class="pl-en">checkIn</span><span class="pl-kos">(</span><span class="pl-s1">bytes</span> <span class="pl-s1">memory</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-s1">external</span> <span class="pl-kos">{</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">isEventActive</span><span class="pl-kos">,</span> <span class="pl-s">"Event is not active"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">block</span><span class="pl-kos">.</span><span class="pl-c1">timestamp</span> <span class="pl-c1">&lt;=</span> <span class="pl-s1">eventDate</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span> <span class="pl-s1">days</span><span class="pl-kos">,</span> <span class="pl-s">"Event has ended"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-c1">!</span><span class="pl-s1">hasAttended</span><span class="pl-kos">[</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">]</span><span class="pl-kos">,</span> <span class="pl-s">"Attendee has already checked in"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">attendeeCount</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">,</span> <span class="pl-s">"Maximum attendees reached"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
        <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-en">verifySignature</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">,</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

        <span class="pl-s1">hasAttended</span><span class="pl-kos">[</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">]</span> <span class="pl-c1">=</span> <span class="pl-c1">true</span><span class="pl-kos">;</span>
        <span class="pl-s1">attendeeCount</span><span class="pl-c1">++</span><span class="pl-kos">;</span>

        <span class="pl-s1">emit</span><span class="pl-kos"></span> <span class="pl-v">AttendeeCheckedIn</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">,</span> <span class="pl-s1">block</span><span class="pl-kos">.</span><span class="pl-c1">timestamp</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">该合同专为会议、研讨会或私人聚会等 Web3 活动而设计。但是，我们没有在链上存储一长串白名单地址（这需要 Gas 且不可扩展），而是做一些更聪明的事情。</p>
<p dir="auto">诀窍如下：</p>
<p dir="auto">活动组织者为每个批准的与会者签署链下消息。</p>
<p dir="auto">然后，与会者将签名消息带到链上以<strong>证明</strong>他们已被邀请。</p>
<p dir="auto">无需预先存储任何东西。智能合约使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code> 验证签名。</p>
<p dir="auto">这是高效、安全的，并且反映了 IRL 门票或二维码的工作方式——但在链上。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（1）合同声明Contract Declaration</strong></h3></div>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">pragma</span> <span class="pl-s1">solidity</span> <span class="pl-c1">^</span><span class="pl-c1">0.8</span><span class="pl-c1">.17</span><span class="pl-kos">;</span>

<span class="pl-s1">contract</span> <span class="pl-v">EventEntry</span> <span class="pl-kos">{</span></pre></div>
<p dir="auto">我们正在使用 Solidity 版本 0.8.17 并创建一个名为 EventEntry 的合约。简单的开始。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（2）事件详细信息和状态变量Event Details &amp; State Variables</strong></h3></div>
<p dir="auto">在我们深入了解智能合约的核心逻辑之前，让我们退后一步问一个简单的问题：</p>
<p dir="auto">Web3 事件实际上需要在链上管理什么？</p>
<p dir="auto">我们不仅仅是在编写一个通用的出席跟踪器——我们正在为活动构建一个<strong>基于签名、Gas 优化的私人访问系统</strong> 。这意味着我们需要跟踪以下内容：</p>
<ul dir="auto">
<li>活动内容</li>
<li>谁负责</li>
<li>当它发生时</li>
<li>可参加人数</li>
<li>谁已经签到了</li>
<li>大门是否还开着</li>
</ul>
<p dir="auto">让我们看看所有这些是如何存储在合约中的。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">string</span> <span class="pl-s1">public</span> <span class="pl-s1">eventName</span><span class="pl-kos">;</span>
<span class="pl-s1">address</span> <span class="pl-s1">public</span> <span class="pl-s1">organizer</span><span class="pl-kos">;</span>
<span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">eventDate</span><span class="pl-kos">;</span>
<span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">;</span>
<span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">attendeeCount</span><span class="pl-kos">;</span>
<span class="pl-s1">bool</span> <span class="pl-s1">public</span> <span class="pl-s1">isEventActive</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这六个变量定义<strong>了活动的一切</strong> ——从谁负责到有多少人可以参加。让我们逐行逐句地浏览一下：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">string</span> <span class="pl-s1">public</span> <span class="pl-s1">eventName</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这是你活动的<strong>人类可读名称human-readable name</strong> ——例如 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">“EthConf 2025”</code> 或 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">“Token-Gated Summit”</code>。</p>
<p dir="auto">由于它被标记为<strong>公共public</strong> ，Solidity 会自动创建一个 getter 函数。</p>
<p dir="auto">任何人都可以调用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">eventName（）</code> 来获取此值——非常适合前端或浏览器显示事件的标题。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">address</span> <span class="pl-s1">public</span> <span class="pl-s1">organizer</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这是<strong>事件组织者（</strong> 部署合约的个人或实体）的以太坊地址。</p>
<p dir="auto">只有这个地址才能<strong>签署与会者批准</strong> （链下）。</p>
<p dir="auto">只有此地址可以<strong>更改事件状态</strong>  （<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">setEventStatus（）</code>）。</p>
<p dir="auto">这使得组织者成为整个系统的看门人。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">eventDate</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这保存了<strong>事件的计划日期event's scheduled date</strong> ，以 <strong>Unix 时间戳</strong>表示。</p>
<p dir="auto">示例：<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">1714569600</code> → 2024 年 4 月 30 日 00：00：00 UTC</p>
<p dir="auto">它用于 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">checkIn（）</code> 函数，以确保人们不会签到太晚。</p>
<p dir="auto">该合同允许在 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">eventDate + 1 天</code>之前签到，以允许时区和延迟灵活性。</p>
<p dir="auto">因此，在实践中，事件在此时间戳后一天<strong>关闭</strong> 。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这对可以签到的人数设定了<strong>硬性上限hard cap</strong> 。</p>
<p dir="auto">如果设置为 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">100</code>，则只有 100 个唯一地址可以成功签入。</p>
<p dir="auto">对于管理私人活动中的有限座位、物理限制或访问控制非常有用。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">uint256</span> <span class="pl-s1">public</span> <span class="pl-s1">attendeeCount</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这会保留已经签到的人数的<strong>运行总数</strong>  <strong>running total</strong>。</p>
<p dir="auto">从 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">0</code> 开始</p>
<p dir="auto">每次新用户成功签入时递增 1</p>
<p dir="auto">用于强制实施 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">maxAttendees</code> 规则</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">bool</span> <span class="pl-s1">public</span> <span class="pl-s1">isEventActive</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">此变量确定事件<strong>当前是否接受签入</strong> 。</p>
<p dir="auto">部署合约时设置为 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">true</code></p>
<p dir="auto">可以由组织者使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">setEventStatus（bool）</code> 打开/关闭</p>
<p dir="auto">在事件处于非活动状态时阻止签入</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>(3)考勤跟踪Attendance Tracking</strong></h3></div>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">mapping</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-c1">=&gt;</span> <span class="pl-s1">bool</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">hasAttended</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">我们使用此映射来<strong>跟踪谁已经签到</strong> ，因此没有人可以签到两次。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">****</h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>(4)事件Events</strong></h3></div>
<p dir="auto">📢</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">event</span> <span class="pl-v">EventCreated</span><span class="pl-kos">(</span><span class="pl-s1">string</span> <span class="pl-s1">name</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">date</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-s1">event</span> <span class="pl-v">AttendeeCheckedIn</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-s1">attendee</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">timestamp</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-s1">event</span> <span class="pl-v">EventStatusChanged</span><span class="pl-kos">(</span><span class="pl-s1">bool</span> <span class="pl-s1">isActive</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">我们发出以下事件是为了提高透明度和前端集成：</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">EventCreated</code>：在部署期间发出一次。</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">AttendeeCheckedIn</code>：每次有人成功签到时触发。</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">EventStatusChanged</code>：允许组织者暂停/恢复事件。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">****</h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>(5)构造函数：部署时设置 Constructor: Setup at Deployment</strong></h3></div>
<p dir="auto">🏗️</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">constructor</span><span class="pl-kos">(</span><span class="pl-s1">string</span> <span class="pl-s1">memory</span> <span class="pl-s1">_eventName</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">,</span> <span class="pl-s1">uint256</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">)</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
    <span class="pl-s1">eventName</span> <span class="pl-c1">=</span> <span class="pl-s1">_eventName</span><span class="pl-kos">;</span>
    <span class="pl-s1">eventDate</span> <span class="pl-c1">=</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">;</span>
    <span class="pl-s1">maxAttendees</span> <span class="pl-c1">=</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">;</span>
    <span class="pl-s1">organizer</span> <span class="pl-c1">=</span> <span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">;</span>
    <span class="pl-s1">isEventActive</span> <span class="pl-c1">=</span> <span class="pl-c1">true</span><span class="pl-kos">;</span>

    <span class="pl-s1">emit</span><span class="pl-kos"></span> <span class="pl-v">EventCreated</span><span class="pl-kos">(</span><span class="pl-s1">_eventName</span><span class="pl-kos">,</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">,</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">构造函数</code>就像安装向导，在部署合约时运行一次——而且只运行一次。让我们来看看每行的作用以及为什么它很重要：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">eventName</span> <span class="pl-c1">=</span> <span class="pl-s1">_eventName</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这会存储您的活动的人类可读名称（例如，“<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">Web3Conf 2025</code>”）。它作为构造函数参数传入并保存在链上，以便任何人都可以稍后使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">eventName（）</code> 函数查询它。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">eventDate</span> <span class="pl-c1">=</span> <span class="pl-s1">_eventDate_unix</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这设置了官方活动日期——但它不是像“2025 年 4 月 21 日” 这样的格式化字符串。它是一个 <strong>Unix 时间戳</strong> （如 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">1745251200</code>），这使得在 Solidity 中进行时间比较变得更加容易。</p>
<p dir="auto">稍后，我们将使用它来检查事件是否仍在进行或已经结束。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">maxAttendees</span> <span class="pl-c1">=</span> <span class="pl-s1">_maxAttendees</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这为可以参加的人数设定了上限。例如，如果最大值为 150，则第 151 人将在入住时被拒绝。</p>
<p dir="auto">拥有此内置限制有助于防止过度拥挤、垃圾邮件或滥用。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">organizer</span> <span class="pl-c1">=</span> <span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这会将部署合同的人员设置为<strong>事件组织者</strong> 。</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">msg.sender</code> 是指部署合约的地址。</p>
<p dir="auto">该地址具有特殊能力，例如激活/停用事件。</p>
<p dir="auto">它也是<strong>唯一</strong>应该允许签署邀请签名的地址，我们稍后会验证。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">isEventActive</span> <span class="pl-c1">=</span> <span class="pl-c1">true</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">默认情况下，活动以活动状态开始，这意味着除非组织者手动禁用它，否则允许签到。</p>
<p dir="auto">稍后我们将创建一个名为 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">setEventStatus（）</code> 的函数，让组织者切换此标志。</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">emit EventCreated(...)</code></p>
<p dir="auto">这行向区块链广播事件，表明该事件已创建。</p>
<p dir="auto">为什么要发出事件？</p>
<p dir="auto">它可以帮助链下应用程序（如前端或浏览器）知道已经注册了新事件。</p>
<p dir="auto">它记录有用的元数据，例如名称、日期和最大容量。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（6）存取控制Access Control</strong></h3></div>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">modifier</span> <span class="pl-en">onlyOrganizer</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span> <span class="pl-c1">==</span> <span class="pl-s1">organizer</span><span class="pl-kos">,</span> <span class="pl-s">"Only the event organizer can call this function"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-s1">_</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">保护某些功能的便捷<strong>修饰符</strong> 。只有组织者可以呼叫他们。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（7） 切换事件状态Toggle Event Status</strong></h3></div>
<p dir="auto">🔁</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function</span> <span class="pl-en">setEventStatus</span><span class="pl-kos">(</span><span class="pl-s1">bool</span> <span class="pl-s1">_isActive</span><span class="pl-kos">)</span> <span class="pl-s1">external</span> <span class="pl-s1">onlyOrganizer</span> <span class="pl-kos">{</span>
    <span class="pl-s1">isEventActive</span> <span class="pl-c1">=</span> <span class="pl-s1">_isActive</span><span class="pl-kos">;</span>
    <span class="pl-s1">emit</span><span class="pl-kos"></span> <span class="pl-v">EventStatusChanged</span><span class="pl-kos">(</span><span class="pl-s1">_isActive</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">使用此选项可以<strong>暂停或恢复</strong>签入。您可能希望在某个时间点之后冻结签到。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">****</h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（8）消息散列 — 签名的关键Message Hashing — Key to Signatures</strong></h3></div>
<p dir="auto">🔏</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function</span> <span class="pl-en">getMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-s1">_attendee</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">view</span> <span class="pl-s1">returns</span> <span class="pl-kos">(</span><span class="pl-s1">bytes32</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-k">return</span> <span class="pl-en">keccak256</span><span class="pl-kos">(</span><span class="pl-s1">abi</span><span class="pl-kos">.</span><span class="pl-en">encodePacked</span><span class="pl-kos">(</span><span class="pl-en">address</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">)</span><span class="pl-kos">,</span> <span class="pl-s1">eventName</span><span class="pl-kos">,</span> <span class="pl-s1">_attendee</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">此功能使<strong>组织者</strong>能够控制活动当前是否接受签到。</p>
<p dir="auto"><strong>它能做什么：</strong></p>
<p dir="auto">🧱</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><style>pre code, pre span { color: #f8f8f2 !important; }</style><code> **`onlyOrganizer` 修饰符：**

      确保只有部署合同的人员（ **组织者** ）才能更改此设置。这可以防止随机用户暂停或恢复事件。
</code></pre></div>
<p dir="auto"><strong><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">isEventActive = _isActive;</code></strong></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><style>pre code, pre span { color: #f8f8f2 !important; }</style><code>        根据传递的参数更新事件的活动状态：

            如果 `_isActive` 为 `true`，则事件为打开。

            如果 `_isActive` 为 `false`，则签入将暂时暂停。
</code></pre></div>
<p dir="auto"><strong><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">emit EventStatusChanged（_isActive）</code>;</strong></p>
<p dir="auto">每次状态变化时都会发出链上事件——对于前端仪表板或区块链浏览器立即反映变化很有用。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（9）以太坊签名消息哈希Ethereum Signed Message Hash</strong></h3></div>
<p dir="auto">✍️</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function</span> <span class="pl-en">getEthSignedMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">bytes32</span> <span class="pl-s1">_messageHash</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">pure</span> <span class="pl-s1">returns</span> <span class="pl-kos">(</span><span class="pl-s1">bytes32</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-k">return</span> <span class="pl-en">keccak256</span><span class="pl-kos">(</span><span class="pl-s1">abi</span><span class="pl-kos">.</span><span class="pl-en">encodePacked</span><span class="pl-kos">(</span><span class="pl-s">"\x19Ethereum Signed Message:\n32"</span><span class="pl-kos">,</span> <span class="pl-s1">_messageHash</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">此功能是以太坊签名验证系统<strong>的重要组成部分</strong> ——这就是它存在的原因。</p>
<hr>
<p dir="auto"><strong>为什么存在这个函数</strong></p>
<p dir="auto">🧠</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><style>pre code, pre span { color: #f8f8f2 !important; }</style><code> 当用户在链下签署数据（如消息的哈希）时，从技术上讲，他们正在签署**任何随机的 32 字节** 。这可能包括交易的哈希值、合约的哈希值或一些完全不相关的数据。
</code></pre></div>
<p dir="auto">这带来了风险：</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><style>pre code, pre span { color: #f8f8f2 !important; }</style><code> 如果有人诱骗用户在链下签署某些内容，然后在链上重复使用该签名来做一些恶意的事情怎么办？
</code></pre></div>
<p dir="auto">为了避免这种情况，以太坊引入了一个<strong>保护性前缀</strong> 。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">****</h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（10）函数的作用</strong></h3></div>
<p dir="auto">🔐</p>
<p dir="auto">这行：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">keccak256</span><span class="pl-kos">(</span><span class="pl-s1">abi</span><span class="pl-kos">.</span><span class="pl-en">encodePacked</span><span class="pl-kos">(</span><span class="pl-s">"\x19Ethereum Signed Message:\n32"</span><span class="pl-kos">,</span> <span class="pl-s1">_messageHash</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">获取原始消息哈希并<strong>用前缀包装它</strong> ，如下所示：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s">"\x19Ethereum Signed Message:\n32"</span> <span class="pl-c1">+</span> <span class="pl-s1">original_hash</span></pre></div>
<p dir="auto">然后它使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">keccak256</code> 再次对整个事情进行哈希处理。</p>
<p dir="auto">这被称为<strong>以太坊签名消息哈希</strong> ，它是像 MetaMask 这样的钱包在你调用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">eth_sign</code> 时使用的<strong>确切格式</strong> 。</p>
<p dir="auto"><strong>为什么这很重要？</strong></p>
<p dir="auto">🔄</p>
<p dir="auto">因为当我们稍后使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover（）</code> 恢复<strong>签名者的地址</strong>时，我们将从这个<strong>前缀包装的哈希中</strong>恢复它，而不是原始哈希。</p>
<p dir="auto">如果您没有正确包装它，验证步骤将失败 - 即使用户正确签名！</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"></h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（11） 签名验证Signature Verification</strong></h3></div>
<p dir="auto">🕵️‍♂️</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function</span> <span class="pl-en">verifySignature</span><span class="pl-kos">(</span><span class="pl-s1">address</span> <span class="pl-s1">_attendee</span><span class="pl-kos">,</span> <span class="pl-s1">bytes</span> <span class="pl-s1">memory</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-s1">public</span> <span class="pl-s1">view</span> <span class="pl-s1">returns</span> <span class="pl-kos">(</span><span class="pl-s1">bool</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-s1">bytes32</span> <span class="pl-s1">messageHash</span> <span class="pl-c1">=</span> <span class="pl-en">getMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">_attendee</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-s1">bytes32</span> <span class="pl-s1">ethSignedMessageHash</span> <span class="pl-c1">=</span> <span class="pl-en">getEthSignedMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">messageHash</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-k">return</span> <span class="pl-en">recoverSigner</span><span class="pl-kos">(</span><span class="pl-s1">ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-c1">==</span> <span class="pl-s1">organizer</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">此功能是我们<strong>邀请验证系统</strong>的核心。它回答了一个简单但有力的问题：</p>
<p dir="auto">“这个签名真的是由组织者创建的吗——它是为这位与会者准备的吗？”</p>
<p dir="auto">让我们逐行分解。</p>
<p dir="auto"><strong>第 1 步：生成基本消息哈希</strong></p>
<p dir="auto">✅</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">bytes32</span> <span class="pl-s1">messageHash</span> <span class="pl-c1">=</span> <span class="pl-en">getMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">_attendee</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这会重新创建<strong>组织者</strong>为特定与会者在链下签名的确切哈希值。</p>
<p dir="auto">该哈希值通常类似于：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">keccak256</span><span class="pl-kos">(</span><span class="pl-s1">contract</span> <span class="pl-s1">address</span> <span class="pl-c1">+</span> <span class="pl-s1">event</span> <span class="pl-s1">name</span> <span class="pl-c1">+</span> <span class="pl-s1">attendee</span> <span class="pl-s1">address</span><span class="pl-kos">)</span></pre></div>
<p dir="auto">这确保了：</p>
<p dir="auto">签名与<strong>此特定合约相关联</strong></p>
<p dir="auto">仅对<strong>此活动</strong>有效</p>
<p dir="auto">它属于<strong>这个确切的用户</strong></p>
<p dir="auto">如果有什么不同——不同的与会者、不同的活动——哈希值就会发生变化。</p>
<p dir="auto"><strong>第 2 步：转换为以太坊签名格式</strong></p>
<p dir="auto">✅</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">bytes32</span> <span class="pl-s1">ethSignedMessageHash</span> <span class="pl-c1">=</span> <span class="pl-en">getEthSignedMessageHash</span><span class="pl-kos">(</span><span class="pl-s1">messageHash</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">正如我们之前所解释的，这用以太坊的标准前缀包装了消息哈希：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s">"\x19Ethereum Signed Message:\n32"</span> <span class="pl-c1">+</span> <span class="pl-s1">messageHash</span></pre></div>
<p dir="auto">为什么？</p>
<p dir="auto">因为像 MetaMask 这样的钱包在签名时会自动添加该前缀——所以我们在验证时也需要包含它，否则检查将失败。</p>
<p dir="auto"><strong>第 3 步：恢复签名者</strong></p>
<p dir="auto">✅</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">return</span> <span class="pl-en">recoverSigner</span><span class="pl-kos">(</span><span class="pl-s1">ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-c1">==</span> <span class="pl-s1">organizer</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">在这里，我们：</p>
<p dir="auto">使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover（）</code>（ 通过辅助函数 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">recoverSigner</code>）提取签名<strong>消息的地址</strong> 。</p>
<p dir="auto">将该地址与<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">组织者</code> （部署此合约的地址）进行比较。</p>
<p dir="auto">如果匹配：  签名有效</p>
<p dir="auto">如果没有：  有人伪造或由其他人签名</p>
<p dir="auto">✅</p>
<p dir="auto">❌</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>（12）recoverSigner – 密码侦探 The Cryptographic Detective</strong></h3></div>
<p dir="auto">🔐</p>
<p dir="auto">这是合约中的实际函数：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function</span> <span class="pl-s1">recoverSigner</span><span class="pl-kos">(</span><span class="pl-s1">bytes32</span> <span class="pl-s1">_ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">bytes</span> <span class="pl-s1">memory</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span>
    <span class="pl-s1">public</span>
    <span class="pl-s1">pure</span>
    <span class="pl-en">returns</span> <span class="pl-kos">(</span><span class="pl-s1">address</span><span class="pl-kos">)</span>
<span class="pl-kos">{</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">.</span><span class="pl-c1">length</span> <span class="pl-c1">==</span> <span class="pl-c1">65</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature length"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

    <span class="pl-s1">bytes32</span> <span class="pl-s1">r</span><span class="pl-kos">;</span>
    <span class="pl-s1">bytes32</span> <span class="pl-s1">s</span><span class="pl-kos">;</span>
    <span class="pl-s1">uint8</span> <span class="pl-s1">v</span><span class="pl-kos">;</span>

    <span class="pl-s1">assembly</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
        <span class="pl-s1">r</span> :<span class="pl-c1">=</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">32</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
        <span class="pl-s1">s</span> :<span class="pl-c1">=</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">64</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
        <span class="pl-s1">v</span> :<span class="pl-c1">=</span> <span class="pl-en">byte</span><span class="pl-kos">(</span><span class="pl-c1">0</span><span class="pl-kos">,</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">96</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
    <span class="pl-kos">}</span>

    <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-s1">v</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">27</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
        <span class="pl-s1">v</span> <span class="pl-c1">+=</span> <span class="pl-c1">27</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">v</span> <span class="pl-c1">==</span> <span class="pl-c1">27</span> <span class="pl-c1">||</span> <span class="pl-s1">v</span> <span class="pl-c1">==</span> <span class="pl-c1">28</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature 'v' value"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

    <span class="pl-k">return</span> <span class="pl-en">ecrecover</span><span class="pl-kos">(</span><span class="pl-s1">_ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">v</span><span class="pl-kos">,</span> <span class="pl-s1">r</span><span class="pl-kos">,</span> <span class="pl-s1">s</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">此功能是我们基于签名的输入系统中的<strong>最后一个侦探步骤</strong> 。它查看签名并找出<strong>哪个以太坊地址签署了它</strong> 。</p>
<p dir="auto">假设有人给了我们一个签名并声称：</p>
<p dir="auto">“这是由活动组织者签署的。这意味着我被允许参加活动。</p>
<p dir="auto">但我们不能盲目相信他们。我们需要<strong>验证</strong>是否：</p>
<p dir="auto">该签名是有效的。</p>
<p dir="auto">它真的来自<strong>组织者的钱包</strong> 。</p>
<p dir="auto">这个函数可以帮助我们做到这一点。</p>
<p dir="auto"><strong>第 1 步：检查签名长度</strong></p>
<p dir="auto">📏</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">.</span><span class="pl-c1">length</span> <span class="pl-c1">==</span> <span class="pl-c1">65</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature length"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">所有以太坊签名的<strong>长度都是 65 字节</strong> ——不多也不少。</p>
<p dir="auto">如果它更短或更长，则可能是损坏的、不完整的或假的。</p>
<p dir="auto">所以如果长度不对，我们会立即停止。</p>
<p dir="auto"><strong>第 2 步：将签名分成 3 个部分</strong></p>
<p dir="auto">📦</p>
<p dir="auto">以太坊签名不仅仅是一大块——它们由 3 个部分组成，称为：</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">r</code>（32 字节）</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">s</code>（32 字节）</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">v</code>（1 字节）</p>
<p dir="auto">这三个值协同工作，以<strong>数学方式证明谁签署了邮件</strong> 。</p>
<p dir="auto">现在，事情变得有点技术性了......</p>
<p dir="auto"><strong>第 3步：使用程序集提取这些值</strong></p>
<p dir="auto">🧙</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">assembly</span> <span class="pl-kos">{</span>
    <span class="pl-s1">r</span> :<span class="pl-c1">=</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">32</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
    <span class="pl-s1">s</span> :<span class="pl-c1">=</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">64</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
    <span class="pl-s1">v</span> :<span class="pl-c1">=</span> <span class="pl-en">byte</span><span class="pl-kos">(</span><span class="pl-c1">0</span><span class="pl-kos">,</span> <span class="pl-en">mload</span><span class="pl-kos">(</span><span class="pl-en">add</span><span class="pl-kos">(</span><span class="pl-s1">_signature</span><span class="pl-kos">,</span> <span class="pl-c1">96</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">)</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">汇编是一种直接从内存访问数据的低级方法。</p>
<p dir="auto">可以把它想象成挖一个盒子，准确地拿出我们需要的东西。</p>
<p dir="auto">我们说：</p>
<p dir="auto">“嘿以太坊，给我从位置 32 开始的前 32 个字节。那是 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">r</code>。</p>
<p dir="auto">“现在给我接下来的 32 字节，从 64 开始。那是<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">s</code> 。</p>
<p dir="auto">“最后给我位置 96 的 1 字节。那是 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">v</code>。</p>
<p dir="auto">我们现在已经有了标志性拼图的所有部分。</p>
<p dir="auto"><strong>第 4 步：根据需要修复 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">V</code> 值</strong></p>
<p dir="auto">🧪</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-s1">v</span> <span class="pl-c1">&lt;</span> <span class="pl-c1">27</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-s1">v</span> <span class="pl-c1">+=</span> <span class="pl-c1">27</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<p dir="auto">有时，不同的钱包或系统会给你一个 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">v</code> 值，即 0 或 1。</p>
<p dir="auto">但以太坊预计是 27 或 28。</p>
<p dir="auto">所以我们只是在需要时进行调整。</p>
<p dir="auto"><strong>第 5 步：验证 v 现在是否正确</strong></p>
<p dir="auto">🚨</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">v</span> <span class="pl-c1">==</span> <span class="pl-c1">27</span> <span class="pl-c1">||</span> <span class="pl-s1">v</span> <span class="pl-c1">==</span> <span class="pl-c1">28</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature 'v' value"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">修复后，我们确保 v 是 27 或 28 - 其他任何东西都是不可接受的。</p>
<p dir="auto">如果是其他任何东西，我们会抛出错误，因为我们不能信任签名。</p>
<p dir="auto"><strong>第 6 步：恢复签名者的地址</strong></p>
<p dir="auto">🔍</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">return</span> <span class="pl-en">ecrecover</span><span class="pl-kos">(</span><span class="pl-s1">_ethSignedMessageHash</span><span class="pl-kos">,</span> <span class="pl-s1">v</span><span class="pl-kos">,</span> <span class="pl-s1">r</span><span class="pl-kos">,</span> <span class="pl-s1">s</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这是最后的时刻。</p>
<p dir="auto">我们称之为 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code>——一个内置的以太坊函数，它采用：</p>
<p dir="auto">签名消息哈希</p>
<p dir="auto">签名值 （<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">v、r、s</code>）</p>
<p dir="auto">它返回<strong>签名者的地址</strong> 。</p>
<p dir="auto">yeah！我们现在知道是谁签署了这条消息。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>(13)checkIn – Web3 活动的前门 The Front Gate of the Web3 Event</strong></h3></div>
<p dir="auto">🎟️</p>
<p dir="auto">这是与会者到达您的活动时将调用的主要功能—— <strong>无论是代币门控聚会、研讨会还是私人发布派对</strong> 。</p>
<p dir="auto">让我们先重新审视一下函数：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-k">function</span> <span class="pl-en">checkIn</span><span class="pl-kos">(</span><span class="pl-s1">bytes</span> <span class="pl-s1">memory</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span> <span class="pl-s1">external</span> <span class="pl-kos">{</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">isEventActive</span><span class="pl-kos">,</span> <span class="pl-s">"Event is not active"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">block</span><span class="pl-kos">.</span><span class="pl-c1">timestamp</span> <span class="pl-c1">&lt;=</span> <span class="pl-s1">eventDate</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span> <span class="pl-s1">days</span><span class="pl-kos">,</span> <span class="pl-s">"Event has ended"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-c1">!</span><span class="pl-s1">hasAttended</span><span class="pl-kos">[</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">]</span><span class="pl-kos">,</span> <span class="pl-s">"Attendee has already checked in"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">attendeeCount</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">,</span> <span class="pl-s">"Maximum attendees reached"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-en">verifySignature</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">,</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

    <span class="pl-s1">hasAttended</span><span class="pl-kos">[</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">]</span> <span class="pl-c1">=</span> <span class="pl-c1">true</span><span class="pl-kos">;</span>
    <span class="pl-s1">attendeeCount</span><span class="pl-c1">++</span><span class="pl-kos">;</span>

    <span class="pl-s1">emit</span><span class="pl-kos"></span> <span class="pl-v">AttendeeCheckedIn</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">,</span> <span class="pl-s1">block</span><span class="pl-kos">.</span><span class="pl-c1">timestamp</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>这个函数在做什么？</strong></h3></div>
<p dir="auto">🧩</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><style>pre code, pre span { color: #f8f8f2 !important; }</style><code>  此功能是**您的数字看门人** 。
</code></pre></div>
<p dir="auto">每次有人想要签到时，他们必须证明：</p>
<p dir="auto">他们被邀请（通过提供有效签名）</p>
<p dir="auto">他们在允许的窗口内签到</p>
<p dir="auto">活动仍在进行中</p>
<p dir="auto">他们尚未签到。</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto"><pre class="notranslate"><style>pre code, pre span { color: #f8f8f2 !important; }</style><code>   还有空余！
</code></pre></div>
<p dir="auto">如果他们通过了所有这些检查，他们就可以通过大门。</p>
<p dir="auto">现在让我们逐行分解这个函数：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">isEventActive</span><span class="pl-kos">,</span> <span class="pl-s">"Event is not active"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">在我们检查其他任何事情之前——该活动是否正在直播？</p>
<p dir="auto">组织者可能已暂停或取消活动。如果是这样， <strong>则不允许任何人签到</strong> 。</p>
<p dir="auto">此标志 （<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">isEventActive</code>） 由组织者使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">setEventStatus（）</code> 函数进行控制。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">block</span><span class="pl-kos">.</span><span class="pl-c1">timestamp</span> <span class="pl-c1">&lt;=</span> <span class="pl-s1">eventDate</span> <span class="pl-c1">+</span> <span class="pl-c1">1</span> <span class="pl-s1">days</span><span class="pl-kos">,</span> <span class="pl-s">"Event has ended"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">此检查上写着：“ <strong>您只能在活动日期后 24 小时之前签到。</strong></p>
<p dir="auto">为什么？</p>
<p dir="auto">因为事件不会永远持续下去。您不希望有人在 5 天后尝试办理登check in手续。</p>
<p dir="auto">通过增加一天，我们给予了轻微的宽限期，同时仍然保持现实。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-c1">!</span><span class="pl-s1">hasAttended</span><span class="pl-kos">[</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">]</span><span class="pl-kos">,</span> <span class="pl-s">"Attendee has already checked in"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">我们不允许重复签到。</p>
<p dir="auto">此行确保<strong>每个地址只能签到一次</strong> 。如果他们已被标记为有人值守，则他们将被阻止再次签到。</p>
<p dir="auto">这是使用 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">hasAttended</code> 映射进行跟踪的。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-s1">attendeeCount</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">maxAttendees</span><span class="pl-kos">,</span> <span class="pl-s">"Maximum attendees reached"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这是你<strong>活动上限</strong> 。</p>
<p dir="auto">如果你最多与会者人数为 100 人，并且已经有 100 人签到，那么无论谁试图进入，门都会关闭。</p>
<p dir="auto">即使他们有有效的签名，一旦达到上限，他们也无法进入。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">require</span><span class="pl-kos">(</span><span class="pl-en">verifySignature</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">,</span> <span class="pl-s1">_signature</span><span class="pl-kos">)</span><span class="pl-kos">,</span> <span class="pl-s">"Invalid signature"</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">这是真正的魔力。</p>
<p dir="auto">此行验证：</p>
<p dir="auto">与会者 （<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">msg.sender</code>）  <strong>实际上被邀请了</strong></p>
<p dir="auto">他们的签名由<strong>活动组织者签名</strong></p>
<p dir="auto">它是专门<strong>为这次活动签名</strong>的</p>
<p dir="auto">这使用了我们之前讨论的所有加密逻辑（消息哈希、以太坊前缀、<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">ecrecover</code>）——整齐地包装在 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">verifySignature（）</code> 帮助程序中。</p>
<p dir="auto">如果签名是假的或无效的，则拒绝访问。</p>
<h3 dir="auto">****</h3>
<p dir="auto"><strong>通过所有检查？太棒啦！</strong></p>
<p dir="auto">✅</p>
<p dir="auto">如果与会者通过了所有要求，我们将记录他们的签到：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">hasAttended</span><span class="pl-kos">[</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">]</span> <span class="pl-c1">=</span> <span class="pl-c1">true</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">我们将呼叫者标记为现在已签到的人。</p>
<p dir="auto">这可以防止重复签入。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">attendeeCount</span><span class="pl-c1">++</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">我们递增总与会者计数。</p>
<p dir="auto">这有助于我们为下一个尝试进入的人强制执行 maxAttendees 限制。</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-s1">emit</span> <span class="pl-v">AttendeeCheckedIn</span><span class="pl-kos">(</span><span class="pl-s1">msg</span><span class="pl-kos">.</span><span class="pl-c1">sender</span><span class="pl-kos">,</span> <span class="pl-s1">block</span><span class="pl-kos">.</span><span class="pl-c1">timestamp</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">我们触发一个事件来记录此人已签到以及签到的时间。</p>
<p dir="auto">这对以下情况很有用：</p>
<p dir="auto">前端 UI</p>
<p dir="auto">区块浏览器</p>
<p dir="auto">链下数据索引（如 The Graph）</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">完整代码详解</h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">📄 签名验证活动合约</h3></div>
<div class="highlight highlight-source-solidity notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// SPDX-License-Identifier: MIT</span>
<span class="pl-k">pragma solidity</span> <span class="pl-k">^</span><span class="pl-c1">0.8.0</span>;

<span class="pl-k">contract</span> <span class="pl-en">SignThis</span> {
    <span class="pl-c1">string</span> <span class="pl-k">public</span> eventName;
    <span class="pl-c1">address</span> <span class="pl-k">public</span> organizer;
    <span class="pl-c1">uint256</span> <span class="pl-k">public</span> eventDate;
    <span class="pl-c1">uint256</span> <span class="pl-k">public</span> maxAttendees;
    <span class="pl-c1">uint256</span> <span class="pl-k">public</span> attendeeCount;
    <span class="pl-c1">bool</span> <span class="pl-k">public</span> isEventActive;

    <span class="pl-k">mapping</span>(<span class="pl-c1">address</span> <span class="pl-k">=&gt;</span> <span class="pl-c1">bool</span>) <span class="pl-k">public</span> hasAttended;

    <span class="pl-k">event <span class="pl-en">EventCreated</span></span>(<span class="pl-c1">string</span> <span class="pl-v">name</span>, <span class="pl-c1">uint256</span> <span class="pl-v">date</span>, <span class="pl-c1">uint256</span> <span class="pl-v">maxAttendees</span>);
    <span class="pl-k">event <span class="pl-en">AttendeeCheckedIn</span></span>(<span class="pl-c1">address</span> <span class="pl-v">attendee</span>, <span class="pl-c1">uint256</span> <span class="pl-v">timestamp</span>);
    <span class="pl-k">event <span class="pl-en">EventStatusChanged</span></span>(<span class="pl-c1">bool</span> <span class="pl-v">isActive</span>);

    <span class="pl-k">constructor</span>(<span class="pl-c1">string</span> <span class="pl-k">memory</span> <span class="pl-v">_eventName</span>, <span class="pl-c1">uint256</span> <span class="pl-v">_eventDate</span>, <span class="pl-c1">uint256</span> <span class="pl-v">_maxAttendees</span>) {
        eventName <span class="pl-k">=</span> _eventName;
        organizer <span class="pl-k">=</span> <span class="pl-c1">msg</span>.<span class="pl-c1">sender</span>;
        eventDate <span class="pl-k">=</span> _eventDate;
        maxAttendees <span class="pl-k">=</span> _maxAttendees;
        isEventActive <span class="pl-k">=</span> <span class="pl-c1">true</span>;

        <span class="pl-k">emit</span> <span class="pl-en">EventCreated</span>(_eventName, _eventDate, _maxAttendees);
    }

    <span class="pl-k">modifier<span class="pl-en"> onlyOrganizer</span></span>() {
        <span class="pl-k">require</span>(<span class="pl-c1">msg</span>.<span class="pl-c1">sender</span> <span class="pl-k">==</span> organizer, <span class="pl-s">"<span class="pl-s">Only organizer</span>"</span>);
        <span class="pl-k">_;</span>
    }

    <span class="pl-k">modifier<span class="pl-en"> eventActive</span></span>() {
        <span class="pl-k">require</span>(isEventActive, <span class="pl-s">"<span class="pl-s">Event not active</span>"</span>);
        <span class="pl-k">_;</span>
    }

    <span class="pl-c">// 使用签名验证参与者身份</span>
    <span class="pl-k">function<span class="pl-en"> checkInWithSignature</span></span>(
        <span class="pl-c1">address</span> <span class="pl-v">attendee</span>,
        <span class="pl-c1">uint8</span> <span class="pl-v">v</span>,
        <span class="pl-c1">bytes32</span> <span class="pl-v">r</span>,
        <span class="pl-c1">bytes32</span> <span class="pl-v">s</span>
    ) <span class="pl-k">external</span> eventActive {
        <span class="pl-k">require</span>(attendeeCount <span class="pl-k">&lt;</span> maxAttendees, <span class="pl-s">"<span class="pl-s">Event full</span>"</span>);
        <span class="pl-k">require</span>(<span class="pl-k">!</span>hasAttended[attendee], <span class="pl-s">"<span class="pl-s">Already checked in</span>"</span>);

        <span class="pl-c">// 构造消息哈希</span>
        <span class="pl-c1">bytes32</span> messageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
            attendee,
            <span class="pl-c1">address</span>(<span class="pl-mi">this</span>),  <span class="pl-c">// 合约地址</span>
            eventName
        ));

        <span class="pl-c">// 以太坊签名消息哈希</span>
        <span class="pl-c1">bytes32</span> ethSignedMessageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
            <span class="pl-s">"<span class="pl-s">\x19Ethereum Signed Message:\n32</span>"</span>,
            messageHash
        ));

        <span class="pl-c">// 恢复签名者地址</span>
        <span class="pl-c1">address</span> signer <span class="pl-k">=</span> <span class="pl-c1">ecrecover</span>(ethSignedMessageHash, v, r, s);

        <span class="pl-c">// 验证签名者是组织者</span>
        <span class="pl-k">require</span>(signer <span class="pl-k">==</span> organizer, <span class="pl-s">"<span class="pl-s">Invalid signature</span>"</span>);

        <span class="pl-c">// 记录参与</span>
        hasAttended[attendee] <span class="pl-k">=</span> <span class="pl-c1">true</span>;
        attendeeCount<span class="pl-k">++</span>;

        <span class="pl-k">emit</span> <span class="pl-en">AttendeeCheckedIn</span>(attendee, <span class="pl-c1">block</span>.<span class="pl-c1">timestamp</span>);
    }

    <span class="pl-c">// 批量签到 (Gas优化)</span>
    <span class="pl-k">function<span class="pl-en"> batchCheckIn</span></span>(
        <span class="pl-c1">address</span>[] <span class="pl-k">calldata</span> <span class="pl-v">attendees</span>,
        <span class="pl-c1">uint8</span>[] <span class="pl-k">calldata</span> <span class="pl-v">v</span>,
        <span class="pl-c1">bytes32</span>[] <span class="pl-k">calldata</span> <span class="pl-v">r</span>,
        <span class="pl-c1">bytes32</span>[] <span class="pl-k">calldata</span> <span class="pl-v">s</span>
    ) <span class="pl-k">external</span> eventActive {
        <span class="pl-k">require</span>(attendees.<span class="pl-mi">length</span> <span class="pl-k">==</span> v.<span class="pl-mi">length</span>, <span class="pl-s">"<span class="pl-s">Array length mismatch</span>"</span>);
        <span class="pl-k">require</span>(attendees.<span class="pl-mi">length</span> <span class="pl-k">==</span> r.<span class="pl-mi">length</span>, <span class="pl-s">"<span class="pl-s">Array length mismatch</span>"</span>);
        <span class="pl-k">require</span>(attendees.<span class="pl-mi">length</span> <span class="pl-k">==</span> s.<span class="pl-mi">length</span>, <span class="pl-s">"<span class="pl-s">Array length mismatch</span>"</span>);
        <span class="pl-k">require</span>(attendeeCount <span class="pl-k">+</span> attendees.<span class="pl-mi">length</span> <span class="pl-k">&lt;=</span> maxAttendees, <span class="pl-s">"<span class="pl-s">Would exceed capacity</span>"</span>);

        <span class="pl-k">for</span> (<span class="pl-c1">uint256</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>; i <span class="pl-k">&lt;</span> attendees.<span class="pl-mi">length</span>; i<span class="pl-k">++</span>) {
            <span class="pl-c1">address</span> attendee <span class="pl-k">=</span> attendees[i];

            <span class="pl-k">if</span> (hasAttended[attendee]) <span class="pl-k">continue</span>;  <span class="pl-c">// 跳过已签到的</span>

            <span class="pl-c1">bytes32</span> messageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
                attendee,
                <span class="pl-c1">address</span>(<span class="pl-mi">this</span>),
                eventName
            ));

            <span class="pl-c1">bytes32</span> ethSignedMessageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
                <span class="pl-s">"<span class="pl-s">\x19Ethereum Signed Message:\n32</span>"</span>,
                messageHash
            ));

            <span class="pl-c1">address</span> signer <span class="pl-k">=</span> <span class="pl-c1">ecrecover</span>(ethSignedMessageHash, v[i], r[i], s[i]);

            <span class="pl-k">if</span> (signer <span class="pl-k">==</span> organizer) {
                hasAttended[attendee] <span class="pl-k">=</span> <span class="pl-c1">true</span>;
                attendeeCount<span class="pl-k">++</span>;
                <span class="pl-k">emit</span> <span class="pl-en">AttendeeCheckedIn</span>(attendee, <span class="pl-c1">block</span>.<span class="pl-c1">timestamp</span>);
            }
        }
    }

    <span class="pl-c">// 验证签名有效性 (不执行签到)</span>
    <span class="pl-k">function<span class="pl-en"> verifySignature</span></span>(
        <span class="pl-c1">address</span> <span class="pl-v">attendee</span>,
        <span class="pl-c1">uint8</span> <span class="pl-v">v</span>,
        <span class="pl-c1">bytes32</span> <span class="pl-v">r</span>,
        <span class="pl-c1">bytes32</span> <span class="pl-v">s</span>
    ) <span class="pl-k">external</span> <span class="pl-k">view</span> <span class="pl-k">returns</span> (<span class="pl-c1">bool</span>) {
        <span class="pl-c1">bytes32</span> messageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
            attendee,
            <span class="pl-c1">address</span>(<span class="pl-mi">this</span>),
            eventName
        ));

        <span class="pl-c1">bytes32</span> ethSignedMessageHash <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
            <span class="pl-s">"<span class="pl-s">\x19Ethereum Signed Message:\n32</span>"</span>,
            messageHash
        ));

        <span class="pl-c1">address</span> signer <span class="pl-k">=</span> <span class="pl-c1">ecrecover</span>(ethSignedMessageHash, v, r, s);
        <span class="pl-k">return</span> signer <span class="pl-k">==</span> organizer;
    }

    <span class="pl-c">// 获取消息哈希 (用于前端签名)</span>
    <span class="pl-k">function<span class="pl-en"> getMessageHash</span></span>(<span class="pl-c1">address</span> <span class="pl-v">attendee</span>) <span class="pl-k">external</span> <span class="pl-k">view</span> <span class="pl-k">returns</span> (<span class="pl-c1">bytes32</span>) {
        <span class="pl-k">return</span> <span class="pl-c1">keccak256</span>(<span class="pl-c1">abi.encodePacked</span>(
            attendee,
            <span class="pl-c1">address</span>(<span class="pl-mi">this</span>),
            eventName
        ));
    }

    <span class="pl-c">// 管理员功能</span>
    <span class="pl-k">function<span class="pl-en"> toggleEventStatus</span></span>() <span class="pl-k">external</span> onlyOrganizer {
        isEventActive <span class="pl-k">=</span> <span class="pl-k">!</span>isEventActive;
        <span class="pl-k">emit</span> <span class="pl-en">EventStatusChanged</span>(isEventActive);
    }

    <span class="pl-k">function<span class="pl-en"> getEventInfo</span></span>() <span class="pl-k">external</span> <span class="pl-k">view</span> <span class="pl-k">returns</span> (
        <span class="pl-c1">string</span> <span class="pl-k">memory</span> <span class="pl-v">name</span>,
        <span class="pl-c1">uint256</span> <span class="pl-v">date</span>,
        <span class="pl-c1">uint256</span> <span class="pl-v">maxCapacity</span>,
        <span class="pl-c1">uint256</span> <span class="pl-v">currentCount</span>,
        <span class="pl-c1">bool</span> <span class="pl-v">active</span>
    ) {
        <span class="pl-k">return</span> (eventName, eventDate, maxAttendees, attendeeCount, isEventActive);
    }
}</pre></div>
<p dir="auto"><strong>✅ 签名验证流程</strong></p>
<ol dir="auto">
<li>组织者链下生成参与者签名 → 2. 参与者提交签名到合约 → 3. 合约使用ecrecover验证签名 → 4. 验证通过则允许签到。整个过程无需预先存储白名单！</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">🔍 前端签名生成示例</h3></div>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// JavaScript 前端代码async function generateSignature(attendeeAddress, contractAddress, eventName) {</span>
<span class="pl-c">// 1. 构造消息const messageHash = ethers.utils.solidityKeccak256(</span>
        <span class="pl-kos">[</span><span class="pl-s">'address'</span><span class="pl-kos">,</span> <span class="pl-s">'address'</span><span class="pl-kos">,</span> <span class="pl-s">'string'</span><span class="pl-kos">]</span><span class="pl-kos">,</span>
        <span class="pl-kos">[</span><span class="pl-s1">attendeeAddress</span><span class="pl-kos">,</span> <span class="pl-s1">contractAddress</span><span class="pl-kos">,</span> <span class="pl-s1">eventName</span><span class="pl-kos">]</span>
    <span class="pl-kos">)</span><span class="pl-kos">;</span>

<span class="pl-c">// 2. 组织者签名const signature = await organizerWallet.signMessage(</span>
        <span class="pl-s1">ethers</span><span class="pl-kos">.</span><span class="pl-c1">utils</span><span class="pl-kos">.</span><span class="pl-en">arrayify</span><span class="pl-kos">(</span><span class="pl-s1">messageHash</span><span class="pl-kos">)</span>
    <span class="pl-kos">)</span><span class="pl-kos">;</span>

<span class="pl-c">// 3. 分离签名组件const { v, r, s } = ethers.utils.splitSignature(signature);</span>

    <span class="pl-k">return</span> <span class="pl-kos">{</span> v<span class="pl-kos">,</span> r<span class="pl-kos">,</span> s <span class="pl-kos">}</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span>

<span class="pl-c">// 使用示例const signature = await generateSignature(</span>
    <span class="pl-s">"0x742d35Cc6634C0532925a3b8D0C9964E5Bd4f071"</span><span class="pl-kos">,</span><span class="pl-c">// 参与者地址</span>
    <span class="pl-s1">contractAddress</span><span class="pl-kos">,</span>
    <span class="pl-s">"Web3 Conference 2024"</span>
<span class="pl-kos">)</span><span class="pl-kos">;</span>

<span class="pl-c">// 调用合约签到await contract.checkInWithSignature(</span>
    <span class="pl-s1">attendeeAddress</span><span class="pl-kos">,</span>
    <span class="pl-s1">signature</span><span class="pl-kos">.</span><span class="pl-c1">v</span><span class="pl-kos">,</span>
    <span class="pl-s1">signature</span><span class="pl-kos">.</span><span class="pl-c1">r</span><span class="pl-kos">,</span>
    <span class="pl-s1">signature</span><span class="pl-kos">.</span><span class="pl-c1">s</span>
<span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto"><strong><g-emoji class="g-emoji" alias="warning">⚠️</g-emoji> 安全注意事项</strong></p>
<ul dir="auto">
<li>签名可能被重放，需要添加nonce或时间戳</li>
<li>确保消息哈希包含足够的上下文信息</li>
<li>验证签名者身份的权威性</li>
<li>考虑签名的有效期限制</li>
<li>防止签名被用于其他合约</li>
</ul>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">📝 Remix实战步骤</h3></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">步骤1: 部署合约</h3></div>
<ol dir="auto">
<li>部署SignThis合约，设置活动信息</li>
<li>记录合约地址和组织者地址</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">步骤2: 生成签名 (使用MetaMask)</h3></div>
<ol dir="auto">
<li>调用<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">getMessageHash(参与者地址)</code>获取消息哈希</li>
<li>在浏览器控制台使用MetaMask签名：</li>
</ol>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-c">// 在浏览器控制台执行const messageHash = "0x...";// 从合约获取的哈希const signature = await ethereum.request({</span>
    method: <span class="pl-s">"personal_sign"</span><span class="pl-kos">,</span>
    <span class="pl-s1">params</span>: <span class="pl-kos">[</span><span class="pl-s1">messageHash</span><span class="pl-kos">,</span> <span class="pl-s1">ethereum</span><span class="pl-kos">.</span><span class="pl-c1">selectedAddress</span><span class="pl-kos">]</span>
<span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">步骤3: 分离签名并验证</h3></div>
<ol dir="auto">
<li>使用在线工具或脚本分离签名的v, r, s</li>
<li>调用<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">verifySignature</code>验证签名有效性</li>
<li>调用<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">checkInWithSignature</code>完成签到</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto">步骤4: 测试批量签到</h3></div>
<ol dir="auto">
<li>为多个地址生成签名</li>
<li>调用<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">batchCheckIn</code>批量处理</li>
<li>观察Gas消耗对比</li>
</ol>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>😁如何在 Remix 中运行基于签名的事件输入系统</strong></h3></div>
<p dir="auto">好吧，是时候让我们的智能合约变为现实了。</p>
<p dir="auto">你是组织者。i你即将举办 <strong>Web3 峰会</strong> 。让我们从头到尾来了解一下——包括签署邀请和签到人们！</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>第 1 步：部署合约</strong></h3></div>
<p dir="auto">🔨</p>
<p dir="auto">1.前往 Remix。</p>
<p dir="auto">将你的 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">EventEntry 合约</code>粘贴到一个新文件中 - 将其命名为 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">EventEntry.sol</code>。</p>
<p dir="auto">使用 <strong>Solidity Compiler</strong> 选项卡进行编译。</p>
<p dir="auto">转到 <strong>“Deploy &amp; Run Transactions</strong> ”选项卡。</p>
<p dir="auto">现在是时候填写构造函数了：</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">eventName</code>：“<code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">Web3 峰会</code>”</p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">eventDate</code>：使用<strong>future Unix timestamp</strong></p>
<p dir="auto">→ 您可以使用类似 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">Math.floor（Date.now（） / 1000） + 86400</code>（现在 + 1 天）之类的东西</p>
<p dir="auto">→ 或者只是粘贴一个硬编码的未来时间戳，比如 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">1714000000</code></p>
<p dir="auto"><code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">最大与会者人数 ：100</code></p>
<p dir="auto">点击<strong>Deploy。</strong></p>
<p dir="auto">恭喜！您现在已经启动了智能活动。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>第 2 步：生成消息哈希</strong></h3></div>
<p dir="auto">🔑</p>
<p dir="auto">要邀请客人，我们需要生成一个与他们的钱包绑定的唯一<strong>哈希值</strong> 。</p>
<p dir="auto">在已部署的合约实例中：</p>
<p dir="auto">叫：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">getMessageHash</span><span class="pl-kos">(</span><span class="pl-s">"0xAttendeeAddressHere"</span><span class="pl-kos">)</span></pre></div>
<p dir="auto">将 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">“0xAttendeeAddressHere”</code> 替换为访客的钱包地址。</p>
<p dir="auto">🧠</p>
<p dir="auto">复制返回的哈希值 — 我们将在下一步中使用它。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>第 3 步：在 Remix 中签署消息</strong></h3></div>
<p dir="auto">✍️</p>
<p dir="auto">是时候充当<strong>活动组织者</strong>并签署客人的哈希了。</p>
<p dir="auto"><strong>创建一个 JavaScript 文件：</strong></p>
<p dir="auto">在<strong>文件资源管理器</strong>中，右键单击并选择<strong>新建文件</strong></p>
<p dir="auto">命名 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">sign.js</code></p>
<p dir="auto">粘贴此脚本：</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-kos">(</span><span class="pl-k">async</span> <span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
  <span class="pl-k">const</span> <span class="pl-s1">messageHash</span> <span class="pl-c1">=</span> <span class="pl-s">"&lt;paste-your-hash-here&gt;"</span><span class="pl-kos">;</span>
  <span class="pl-k">const</span> <span class="pl-s1">accounts</span> <span class="pl-c1">=</span> <span class="pl-k">await</span> <span class="pl-s1">web3</span><span class="pl-kos">.</span><span class="pl-c1">eth</span><span class="pl-kos">.</span><span class="pl-en">getAccounts</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
  <span class="pl-k">const</span> <span class="pl-s1">organizer</span> <span class="pl-c1">=</span> <span class="pl-s1">accounts</span><span class="pl-kos">[</span><span class="pl-c1">0</span><span class="pl-kos">]</span><span class="pl-kos">;</span> <span class="pl-c">// first account in Remix</span>
  <span class="pl-k">const</span> <span class="pl-s1">signature</span> <span class="pl-c1">=</span> <span class="pl-k">await</span> <span class="pl-s1">web3</span><span class="pl-kos">.</span><span class="pl-c1">eth</span><span class="pl-kos">.</span><span class="pl-en">sign</span><span class="pl-kos">(</span><span class="pl-s1">messageHash</span><span class="pl-kos">,</span> <span class="pl-s1">organizer</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
  <span class="pl-smi">console</span><span class="pl-kos">.</span><span class="pl-en">log</span><span class="pl-kos">(</span><span class="pl-s">"Signature:"</span><span class="pl-kos">,</span> <span class="pl-s1">signature</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">将 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">“&lt;paste-your-hash-here&gt;”</code> 替换为您刚刚复制的哈希值。</p>
<p dir="auto"><strong>现在运行它：</strong></p>
<p dir="auto">右键单击 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">sign.js</code> 并选择<strong>运行</strong> 。</p>
<p dir="auto">Remix 会自动包含 <strong>web3.js</strong>，因此您无需安装任何东西。</p>
<p dir="auto">✅</p>
<p dir="auto">您将在 Remix 终端中看到打印的签名。</p>
<p dir="auto"><strong>这是怎么回事？</strong></p>
<p dir="auto">🧠</p>
<p dir="auto">我们使用部署者（即组织者）的<strong>私钥</strong>在链下<strong>对消息哈希进行签名</strong> 。这模拟了您的后端服务器在现实生活中会做什么。</p>
<div class="markdown-heading" dir="auto"><h3 tabindex="-1" class="heading-element" dir="auto"><strong>第 4 步：以与会者身份签到</strong></h3></div>
<p dir="auto">🪪</p>
<p dir="auto">现在让我们切换角色 - 您是到达活动的与会者，因此切换到与会者地址</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto"><pre><span class="pl-en">checkIn</span><span class="pl-kos">(</span><span class="pl-s">"&lt;paste-signature-here&gt;"</span><span class="pl-kos">)</span></pre></div>
<p dir="auto">粘贴您从上一步获得的确切签名。</p>
<p dir="auto">📌</p>
<p dir="auto">如果一切顺利：</p>
<p dir="auto">系统将标记为已签到。</p>
<p dir="auto">活动的与会人数将增加</p>
<p dir="auto">协定将发出 <code style="background: rgba(139, 115, 85, 0.15); color: var(--warm-brown); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(139, 115, 85, 0.3);">AttendeeCheckedIn</code> 事件</p>
<p dir="auto">🎉</p>
<p dir="auto">就这样，我们建立了自己的 Web3 访客名单——无需在链上存储任何地址。我们没有弄乱存储空间或支付汽油来更新白名单，而是使用加密签名让与会者证明他们是被邀请的。活动组织者就像一个数字保镖，在幕后签署批准，而智能合约则在门口检查这些签名。它干净、高效且更加灵活——这是真实事件可以实际使用的那种系统。无论您是举办代币门控派对还是开发者聚会，这种模式都能为您提供所有安全性，而无需链上包袱。</p>
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">3、下一步</h1></div>
<p dir="auto"><strong>尝试以下改进:</strong></p>
<ol dir="auto">
<li>添加nonce防止签名重放攻击</li>
<li>实现签名有效期机制</li>
<li>创建多级权限系统 (组织者、志愿者、参与者)</li>
<li>实现签名撤销功能</li>
<li>添加签名使用次数限制</li>
<li>创建基于签名的投票系统</li>
</ol>
<p dir="auto"><strong>扩展知识</strong></p>
<p dir="auto"><strong>EIP-712 结构化签名</strong></p>
<div class="highlight highlight-source-solidity notranslate position-relative overflow-auto" dir="auto"><pre><style>pre code, pre span { color: #f8f8f2 !important; }
        /* 修复 GitHub 代码块样式 */
        .md-content .highlight,
        .md-content .highlight-source-solidity,
        .md-content .highlight-source-js,
        .md-content .highlight-source-javascript {
            background: #2d2a2e !important;
            border-radius: 10px;
            padding: 20px !important;
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #3a363b;
        }
        
        .md-content .highlight pre,
        .md-content .highlight-source-solidity pre,
        .md-content .highlight-source-js pre {
            background: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
        }
        
        .md-content .highlight code,
        .md-content .highlight pre code,
        .md-content .highlight pre span,
        .md-content .highlight-source-solidity code,
        .md-content .highlight-source-solidity pre code,
        .md-content .highlight-source-solidity pre span,
        .md-content .highlight-source-js code,
        .md-content .highlight-source-js pre code,
        .md-content .highlight-source-js pre span {
            color: #f8f8f2 !important;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace !important;
            font-size: 0.9rem !important;
            line-height: 1.6 !important;
        }
        
        .md-content code:not(pre code) {
            background: rgba(139, 115, 85, 0.15) !important;
            color: var(--warm-brown) !important;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(139, 115, 85, 0.3);
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .md-content .markdown-heading .anchor {
            display: none !important;
        }
        
        .md-content .snippet-clipboard-content {
            background: #2d2a2e !important;
            border-radius: 10px;
            padding: 20px !important;
            margin: 20px 0;
        }
        
        .md-content .snippet-clipboard-content pre code {
            color: #f8f8f2 !important;
        }

    
        /* 修复 GitHub 代码块样式 */
        .md-content .highlight,
        .md-content .highlight-source-solidity,
        .md-content .highlight-source-js,
        .md-content .highlight-source-javascript {
            background: #2d2a2e !important;
            border-radius: 10px;
            padding: 20px !important;
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #3a363b;
        }
        
        .md-content .highlight pre,
        .md-content .highlight-source-solidity pre,
        .md-content .highlight-source-js pre {
            background: transparent !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
        }
        
        .md-content .highlight code,
        .md-content .highlight pre code,
        .md-content .highlight pre span,
        .md-content .highlight-source-solidity code,
        .md-content .highlight-source-solidity pre code,
        .md-content .highlight-source-solidity pre span,
        .md-content .highlight-source-js code,
        .md-content .highlight-source-js pre code,
        .md-content .highlight-source-js pre span {
            color: #f8f8f2 !important;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace !important;
            font-size: 0.9rem !important;
            line-height: 1.6 !important;
        }
        
        .md-content code:not(pre code) {
            background: rgba(139, 115, 85, 0.15) !important;
            color: var(--warm-brown) !important;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(139, 115, 85, 0.3);
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .md-content .markdown-heading .anchor {
            display: none !important;
        }
        
        .md-content .snippet-clipboard-content {
            background: #2d2a2e !important;
            border-radius: 10px;
            padding: 20px !important;
            margin: 20px 0;
        }
        
        .md-content .snippet-clipboard-content pre code {
            color: #f8f8f2 !important;
        }

    </style><span class="pl-c">// EIP-712 提供更安全的结构化签名</span>
<span class="pl-k">struct<span class="pl-en"> Permit</span></span> {
    <span class="pl-c1">address</span> owner;
    <span class="pl-c1">address</span> spender;
    <span class="pl-c1">uint256</span> value;
    <span class="pl-c1">uint256</span> nonce;
    <span class="pl-c1">uint256</span> deadline;
}

<span class="pl-c1">bytes32</span> <span class="pl-k">constant </span>PERMIT_TYPEHASH <span class="pl-k">=</span> <span class="pl-c1">keccak256</span>(
    <span class="pl-s">"<span class="pl-s">Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)</span>"</span>
);</pre></div>
<p dir="auto">EIP-712提供了更安全、用户友好的签名方式，被广泛用于DeFi协议。</p>
<p dir="auto"><strong>签名应用场景对比</strong></p>
<markdown-accessiblity-table data-catalyst=""><table>
<thead>
<tr>
<th>应用</th>
<th>优势</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>白名单验证</td>
<td>Gas高效</td>
<td>NFT铸造、活动签到</td>
</tr>
<tr>
<td>元交易</td>
<td>用户无需ETH</td>
<td>DApp用户体验</td>
</tr>
<tr>
<td>Permit授权</td>
<td>一步完成授权</td>
<td>DeFi协议集成</td>
</tr>
</tbody>
</table></markdown-accessiblity-table>
                </div>
            </div>
        </div>
    </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/solidity.min.js"></script>
    <script>
        hljs.highlightAll();
        
        // 平滑滚动
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
            
        // Sneha的一封来信模块功能
        document.addEventListener('DOMContentLoaded', function() {
            const envelopeContainer = document.getElementById('envelope-container');
            const answerModal = document.getElementById('answer-modal');
            const closeLetter = document.getElementById('close-letter');
            
            if (!envelopeContainer || !answerModal || !closeLetter) {
                return; // 如果元素不存在，直接返回
            }
            
            // 点击信封打开弹窗
            envelopeContainer.addEventListener('click', function() {
                envelopeContainer.classList.add('open');
                
                // 延迟显示弹窗，让信封翻转动画完成
                setTimeout(function() {
                    answerModal.style.display = 'flex';
                    setTimeout(function() {
                        answerModal.classList.add('open');
                    }, 50);
                }, 400);
            });
            
            // 关闭弹窗
            closeLetter.addEventListener('click', function() {
                answerModal.classList.remove('open');
                
                setTimeout(function() {
                    answerModal.style.display = 'none';
                    envelopeContainer.classList.remove('open');
                }, 600);
            });
            
            // 点击弹窗外部关闭
            answerModal.addEventListener('click', function(e) {
                if (e.target === answerModal) {
                    closeLetter.click();
                }
            });
        });
    </script>
</body>
</html>
                

                setTimeout(function() {

                    answerModal.style.display = 'none';

                    envelopeContainer.classList.remove('open');

                }, 600);

            });

            

            // 点击弹窗外部关闭

            answerModal.addEventListener('click', function(e) {

                if (e.target === answerModal) {

                    closeLetter.click();

                }

            });

        });

    </script>

</body>

</html>

